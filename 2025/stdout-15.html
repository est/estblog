<!DOCTYPE html>
<html>
  <head>
    <title>gRPC Python, AsyncIO and multiprocess ‚Äì est „ÅÆ ËæìÂÖ• ËæìÂá∫ÂíåÂá∫ÂÖ•</title>
<link rel="icon" href="https://est.im/favicon.svg">
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' https://disqus.com https://player.bilibili.com https://www.youtube.com;">
    <link href="https://feeds.feedburner.com/initiative" type="application/rss+xml" rel="alternate" title="est „ÅÆ ËæìÂÖ• ËæìÂá∫ÂíåÂá∫ÂÖ• RSS Feed" />

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="gRPC Python, AsyncIO and multiprocess" />

    <link rel="canonical" href="https://blog.est.im/2025/stdout-15" />
    <meta property="og:url" content="https://blog.est.im/2025/stdout-15">
    <meta property="og:type" content="article">
    <meta property="og:title" content="gRPC Python, AsyncIO and multiprocess">

    <link rel="stylesheet" href="/theme/css/normalize.min.css" />
    <link rel="stylesheet" href="/theme/css/style.css" />


    <style>
      body {
        background: #ecedef url("/theme/img/ignasi_pattern_s.png") repeat;
      }
    </style>
  </head>
  <body class="single-body">
<nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="/" class="nav-text">
    est „ÅÆ ËæìÂÖ• ËæìÂá∫ÂíåÂá∫ÂÖ•
  </a></h1>
  <div class="hamburger-menu">
    <button>
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://feeds.feedburner.com/initiative" class="hamburger-menu-overlay-link">RSS</a></li>
      <li><a href="/about" class="hamburger-menu-overlay-link">About</a></li>
      <li><a href="/category" class="hamburger-menu-overlay-link">Category</a></li>

    </ul>
  </div>
</nav>    <main class="content side-text-padding">
<article class="post">
  <header class="post-header">
    <h2 class="post-title">gRPC Python, AsyncIO and multiprocess</h2>
    <p class="post-date">Posted <time datetime="2025-11-04T10:46:00+08:00">2025-11-04</time> | <span>stdout</span></p>
  </header>

  
  <p>I am torn about writing this. AsyncIO in Python is always a mess, protobuf is another, gRPC is the worst of them all because of all that boilerplate code that does nothing but trouble.</p>
<p>The task I am facing is integrating a mesh API <strong>server</strong> based on our internal codebase. </p>
<h2>non-gRPC options</h2>
<p>I mean, gRPC is just h2+protobuf, how hard could it be? Even <a href="https://uwsgi-docs.readthedocs.io/en/latest/SPDY.html">uWSGI had h2</a> from decades ago</p>
<p>Turns out the options are quite limited. h2 in uWSGI was major versions behind, SPDYv3 never took off. gRPC and h2 are related but different because the frames are marked and handled differently.</p>
<p>So there's either <code>hypercorn</code> or fallback to gRPC. To avoid further mess I decided to stick with gRPC</p>
<h2>infectious async/await</h2>
<p>Now I face another challenge: The existing business logic is written in async/await style (cue FastAPI fad)</p>
<p>I carefully studied the <a href="https://github.com/grpc/grpc/blob/master/examples/python/helloworld/async_greeter_server_with_graceful_shutdown.py">gRPC async hello world example</a></p>
<p>Everything ran great, except the notorious GIL, my gRPC server runs but only on one single CPU. </p>
<h2>multiprocess</h2>
<p>Old school solution to GIL: spawn many processes. Given a 1:1 map to worker CPU. Easy? There's an <a href="https://github.com/grpc/grpc/tree/master/examples/python/multiprocessing">official <code>multiprocessing</code> example</a></p>
<p>It worked... until it didn't. The major selling point of h2 is connection multiplexing, one TCP connection to serve all concurrency. And our mesh client is so good at this, only one worker consumes 100% of one CPU and the rest simply idle. ü§£</p>
<h2>SO_REUSEPORT</h2>
<p>I also tried to implement a prefork worker on my own. Let's get rid of master because <s>political-correctness</s> we have <code>SO_REUSEPORT</code> already.</p>
<p>Unfortunately it didn't work at all, because of h2's multiplexing nature. The kernel won't schedule requests if there's only one single connection.</p>
<h2>ProcessPoolExecutor</h2>
<p>I looked closely and found how gRPC inits:</p>
<p><code>grpc.server(futures.ThreadPoolExecutor(max_workers=10))</code></p>
<p>Maybe swap it with <code>ProcessPoolExecutor()</code> ?</p>
<p>Nope, server went dead with a timeout. Don't have time to look into C/C++ details. Nope.</p>
<p>It seems gRPC only allows <code>ThreadPoolExecutor()</code>.</p>
<p>Why does Google even allow it as a parameter then?</p>
<h2>The apply_async() hallucination</h2>
<p>Out of despair, next I asked ChatGPT. The advanced AI model said: just use <code>multiprocessing</code> in your invokes</p>
<p>Yeah why not. So how do I run <code>async</code> in <code>multiprocessing</code>?</p>
<p>ChatGPT hallucinated: use <a href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool.apply_async"><code>apply_async</code></a>. I initially believed that shit only to find it means the func will return an AsyncResult object, not running some <code>async/await</code> code. btw, I found the <code>.apply()</code> is just a shortcut for <code>.apply_async().get()</code></p>
<h2>Putting it together</h2>
<p>I got the mess to work eventually.</p>
<ol>
<li>Create a normal gRPC server with <code>add_generic_rpc_handlers</code> and stuff</li>
<li>Create a <code>pool = ProcessPoolExecutor(...)</code> before the <code>unary_unary_rpc_method_handler</code>, with an <code>initializer</code> that spawns a global <code>loop = asyncio.new_event_loop()</code>.  <br />
It had to be global because <code>concurrent.futures</code> only allows it this way</li>
<li>Run <code>loop.run_until_complete()</code> inside <code>pool.submit()</code></li>
</ol>
<h2>lessons learned</h2>
<p>If you aren't a try-hard:</p>
<ul>
<li>
<p>avoid async</p>
</li>
<li>
<p>avoid gRPC</p>
</li>
</ul>
</article>

<div class="comments">
  <h2>Comments</h2>
  <script type="text/javascript" defer src="https://c.est.im/req4cmt.js"></script>
</div>    </main>


  </body>

</html>