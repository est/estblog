<!DOCTYPE html>
<html>
  <head>
    <title>est の 输入输出 - stdout category</title>

    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link href="https://feeds.feedburner.com/initiative" type="application/rss+xml" rel="alternate" title="est の 输入输出 RSS Feed" />

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="This blog is rated 🔞, viewer discretion is advised" />

    <meta property="og:url" content="https://blog.est.im">
    <meta property="og:type" content="website">
    <meta property="og:title" content="est の 输入输出">
    <meta property="og:description" content="This blog is rated 🔞, viewer discretion is advised">

    <link rel="stylesheet" href="/theme/css/normalize.min.css" />
    <link rel="stylesheet" href="/theme/css/style.css" />


    <style>
      body {
        background: #ecedef url("/theme/img/ignasi_pattern_s.png") repeat;
      }
    </style>
  </head>
  <body class="list-body">
<nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="/" class="nav-text">
    est の 输入输出
  </a></h1>
  <div class="hamburger-menu">
    <button>
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://feeds.feedburner.com/initiative" class="hamburger-menu-overlay-link">RSS</a></li>
      <li><a href="/about" class="hamburger-menu-overlay-link">About</a></li>

      <li><a href="/category/archive" class="hamburger-menu-overlay-link">archive</a></li>
      <li><a href="/category/stderr" class="hamburger-menu-overlay-link">stderr</a></li>
      <li><a href="/category/stdin" class="hamburger-menu-overlay-link">stdin</a></li>
      <li><a href="/category/stdout" class="hamburger-menu-overlay-link active">stdout</a></li>

    </ul>
  </div>
</nav>    <main class="card-container side-gutter">
      <header class="list-header">
        <p class="list-header-subtext">This blog is rated 🔞, viewer discretion is advised</p>
        <!-- <h1 class="list-header-title">est の 输入输出</h1> -->
      </header>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2024/stdout-03"  rel="bookmark" >
              <h2 class="card-title">穷人的supervisor OOM killer</h2>
            </a>
            <p class="card-text"><p>厂里的docker上跑了个supervisord，用来把挂掉的进程拉起来。最近的问题不是进程挂掉，而是内存泄漏</p>
<p>跑着跑着内存爆了，然后宿主机OOM随机杀掉一个进程，结果占用内存最大的那个还活着，正常的进程反而gg，该漏的继续漏，然后反复OOM。想看下哪里漏了，<code>--cap-add=SYS_PTRACE</code> 也不给加，OOM策略也不给调，思来想去只能自己做防水补漏了。做起来也简单，supervisor再跑一套bash脚本即可：</p>
<pre><code>while true; do
  p=`ps --no-headers  -xo rss,pid --sort=-rss | awk '{
    if($1 &gt; 1000000){ print $2 }
  }'`
  kill $p 2&gt;/dev/null || echo "everything fine";
  sleep 60;
done;
</code></pre>
<p><code>1000000</code> 代表1G 内存。 <code>sleep 60</code> 表示 每60秒检查一次。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2024-02-27T16:48:00+08:00">2024-02-27</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2024/stdout-02"  rel="bookmark" >
              <h2 class="card-title">从 幻兽帕鲁 Palworld 设想一下未来的联机游戏</h2>
            </a>
            <p class="card-text"><p>打开steam刷到一个新闻《<a href="https://store.steampowered.com/news/app/294100/view/5851926268001690398?l=english">Ten years of RimWorld</a>》。啊？都十年了？回想起来最近非常爆火 幻兽帕鲁 Palworld ，被大家称为缝合怪，什么都缝了。细细盘点一下我对该类别游戏大杂烩的一个评价，以及我对未来游戏机制的一个YY。</p>
<h2>Minecraft 挖矿争霸</h2>
<p>我从这玩意还没中文名字的beta时代就开始玩（盗版），从山脚下一个 1x2 穴居的第一夜，挖到自己的第一铲煤，再到湖底水晶宫，然后修建自己的铁路在广袤的平原和山间品味那让人留连忘返 procedure generated terrain ，那个时候真的能给人一种激动。</p>
<p>后来搞的什么创造模式，各种复杂的机制和道具，没那个简单的快乐了。</p>
<h2>Conan Exiles</h2>
<p>和 minecraft 的 voxel 建筑风格相比，它的建筑是由<a href="https://blog.est.im/201905/stdin-003">正三角形、正方形构造出来的奇特镶嵌</a> 。当然还有特色的 wheel of pain 驯奴系统，简直解放劳动力啊</p>
<h2>Rimworld</h2>
<p>这玩意好就好在它那套 story-teller 带来的调性，很有那个味。后来的其他作品比如 Stranded: Alien Down 虽然设施设备、机制都堆了，但是总给人一种单薄，后期没劲的感觉。Rimworld 的限制就在于 2D 而且固定尺寸地图，不是 open-world</p>
<h2>Grand Theft Auto</h2>
<p>这玩意当年从 GTA:SA 接触觉得简直是神作啊！无缝地图在当年看来就是魔法一般。而且迄今为止它也是没有太多科幻元素，完全以「现代」为题材的都市类游戏，国产的喜欢做三国、仙侠，国外的喜欢中世纪、废土和赛博。凸显了 GTA 的独特生态位。当然这玩意玩 online 就是纯纯的 grind，还好我早就通过外挂刷了几个亿，很轻松惬意。（声明：外挂只用来刷钱，并不具备其它不公平功能）。这玩意在我心目中是 open-world 当之无愧的开创者和王者。</p>
<h2>Palworld</h2>
<p>接触了一下这玩意，其实我对 pokemon 一直有耳闻但是完全不懂，现在看来有点类似收集+配种这样一个机制。想起来玩一些 MMORPG 比如 Black Desert 发现一个叫做 「family」的机制很有趣，你可以创建多个角色并切换，部分物品甚至是通用的。但是这玩意感觉除了对不同角色体验一番，并不能带来 1+1&gt;2 的效果。我当时就非常希望同一个 family 的角色能相互配合，就像「Dragon Age: Origins」里一样，在行走和打架的时候能随时切换，不同的职业甚至能打出来一些配合，那该有多好。</p>
<h2>缝合</h2>
<p>游戏里最蛋痛的一点，对资源开采的大量需求，应该可以把玩家的角色托付给AI挂机，正如 Black Desert 的 auto-fishing 一样。Palworld 这一点就缝合的相当有趣了，原版的 pokemon 据说只能抓来打架，这里变成了还可以是生产力。比 Conan Exiles 里的奴隶机制更有意思。综合我前面的设想，我觉得以后的联机游戏，player-character 应该不是一个，而是一群。有血缘或者劳动附庸关系的「家族」。玩家应该有自由度选择控制其中一个或多个，玩家离线的时候这个「家族」应该也会按照设定进行生产和劳动。。。。甚至防御！</p>
<p>如果考虑死亡掉落机制，那么可以设计一套更有趣的系统：</p>
<ol>
<li>捏脸不能全部自定义，而是类似 Red Dead Redemption 那样的双亲继承+微调</li>
<li>角色的职业，天赋点，也应该通过血缘获得，而不是生硬的数值</li>
<li>玩家控制角色可以重伤，甚至死亡。死了就真死透了。但是你可以多生育子女，选一个比如95%相似度的，继续玩。</li>
<li>玩家随身物品，如果掉落，需要家族里其他人去捞，或者发悬赏换回</li>
<li>子女太多可以交给社会化抚养，变成NPC。</li>
<li>付费玩家可以全价自定义投胎，免费玩家可以从弃养的NPC里挑选。</li>
<li>家族里其他角色可以随时控制，或者分配生产、战斗任务</li>
<li>有俘虏、雇佣，随从等「条约」系统支持跨血缘配合</li>
<li>都说文明周边会刷出来蛮族。蛮族哪里来的？超出承载能力的人口流亡出去的。一个「family」生育太多，养不起，可以放出去「自谋生路」，投靠别的部落。NPC杂兵不应该是无脑复制，而是每个角色都有个背景板。类似 Rimworld 里 colonist 被海盗抓走俘虏，颠破流离。</li>
</ol>
<p>这样的体系下，说不定可以加入家族政治勾心斗角，最后演变成类似 十字军之王 一类的策略游戏？23333</p>
<p>在家族这样的设定下，还需要解决最后一个拼图：玩家终归是要时不时AFK的。那么玩家一定会需要据点。这类 base-building 游戏也烂大街了。但是最大的问题就是，一个服务器地图是有限的，好的建家点位就那么几个，目前联机游戏一般的做法是搞一套巨复杂的防御机制，高难度陷阱防止别的玩家抄家。实际上抄家和被抄家都挺难受的。</p>
<p>我的想法是，要不干脆把  base-building 改成关卡编辑器。把你基地当成Tower of Defense 的地牢来设计，家族成员通过占位和分工设计成闯关NPC，最后把你家族里战斗力最强的配置上最好的装备和武器设计成boss。然后拿一部分家产作为其他玩家闯关成功的奖励。别的玩家来闯关，是闯你家的副本，这样不完全破坏你的家，也可以让玩家发挥自己聪明才智，让别的玩家体会会被阴、被虐的乐趣。</p>
<p>有了「家族」和「关卡」两套机制，游戏的玩家也成了游戏机制进化的一部分，可以说病毒式传播，生生不息了。反正我又不做游戏，所以随便YY，不用关心可行性和成本，谁有兴趣请自行挪用，最好做出来能邀请我内测 :)</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2024-02-12T14:52:00+08:00">2024-02-12</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2024/stdout-01"  rel="bookmark" >
              <h2 class="card-title">FastAPI/Starlette 长连接感知断开</h2>
            </a>
            <p class="card-text"><p>之前写过如何 <a href="/2023/stdout-12">在服务器重启的时候感知长连接</a>，最近发现折腾复杂了。</p>
<p><a href="https://github.com/encode/starlette/discussions/1776">https://github.com/encode/starlette/discussions/1776</a></p>
<p>测试代码： </p>
<pre><code>import asyncio

async def async_streamer():
    try:
        while True:
            yield b&quot;--boundary\r\nContent-Type: text/plain\r\nContent-Length: 1\r\n\r\n1\r\n&quot;
            await asyncio.sleep(0)
    except asyncio.CancelledError:
        print(&quot;caught cancelled error&quot;)

app = Starlette(routes=[
    Route('/async', async_endpoint),
])
</code></pre>
<p>跑起来： <code>uvicorn stream:app</code></p>
<p>这段代码粗一看没啥大不了的，但是神奇的地方在于，如果去掉 <code>try ... except asyncio.CancelledError</code> ，代码也能正常跑</p>
<pre><code>
async def async_streamer():
    while True:
        yield b&quot;--boundary\r\nContent-Type: text/plain\r\nContent-Length: 1\r\n\r\n1\r\n&quot;
        await asyncio.sleep(0)
</code></pre>
<p>而且不会报错！最蛋痛的是，这玩意因为是个 <code>while True</code>，如果你里面有打开的数据库连接，是不会中断的，也不会回收的。因为这个 coroutine 没有继续 <code>async for</code> 来消费，就一直挂在进程里当僵尸了！</p>
<p>加上 <code>try ... except asyncio.CancelledError</code>，能捕获出错，也能处理善后了。</p>
<p>真是神奇啊。不知道是 uvicorn 的特性，还是 ASGI 都这样。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2024-01-18T14:44:12+08:00">2024-01-18</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-19"  rel="bookmark" >
              <h2 class="card-title">不能忘却的记忆</h2>
            </a>
            <p class="card-text"><p>由于小爱同学不能导出就挨个手打出来。纪念这个日子。</p>
<p><img alt="" src="/images/2023/stdout-19-01.jpg" /></p>
<p>一年前这几天，孩子和爱人相继病倒，我本来以为苟住了能以幸免结果在家人好转的时候一测体温发现偏高。于是赶紧洗了个澡，把小卧室腾出来，弄好电暖气、电吹风，装满开水壶，把mbp和其它个人物品搬进去，因为我知道接下来的日子将会无比煎熬。</p>
<table>
<thead>
<tr>
<th>date</th>
<th>℃</th>
</tr>
</thead>
<tbody>
<tr>
<td>2022-12-18 16:41</td>
<td>37.3</td>
</tr>
<tr>
<td>2022-12-18 16:43</td>
<td>37.3</td>
</tr>
<tr>
<td>2022-12-18 17.31</td>
<td>38.1</td>
</tr>
<tr>
<td>2022-12-18 17:46</td>
<td>38.3</td>
</tr>
<tr>
<td>2022-12-18 18:33</td>
<td>39.3</td>
</tr>
<tr>
<td>2022-12-18 18.41</td>
<td>38.7</td>
</tr>
<tr>
<td>2022-12-18 19:07</td>
<td>38.3</td>
</tr>
<tr>
<td>2022-12-18 19:15</td>
<td>38.7</td>
</tr>
<tr>
<td>2022-12-18 20:01</td>
<td>38.6</td>
</tr>
<tr>
<td>2022-12-18 21:11</td>
<td>39.5</td>
</tr>
<tr>
<td>2022-12-18 21:20</td>
<td>38.9</td>
</tr>
<tr>
<td>2022-12-18 21:26</td>
<td>39.1</td>
</tr>
<tr>
<td>2022-12-18 21:41</td>
<td>39.2</td>
</tr>
<tr>
<td>2022-12-18 23:30</td>
<td>38.4</td>
</tr>
<tr>
<td>2022-12-19 02:38</td>
<td>39.3</td>
</tr>
<tr>
<td>2022-12-19 02:48</td>
<td>38.3</td>
</tr>
<tr>
<td>2022-12-19 10:05</td>
<td>38.5</td>
</tr>
<tr>
<td>2022-12-19 10:12</td>
<td>37.9</td>
</tr>
<tr>
<td>2022-12-19 10:36</td>
<td>37.4</td>
</tr>
<tr>
<td>2022-12-19 11:19</td>
<td>37.7</td>
</tr>
<tr>
<td>2022-12-19 14:03</td>
<td>37.7</td>
</tr>
<tr>
<td>2022-12-19 14:29</td>
<td>37.0</td>
</tr>
<tr>
<td>2022-12-19 15:18</td>
<td>37.7</td>
</tr>
<tr>
<td>2022-12-19 16:33</td>
<td>37.6</td>
</tr>
<tr>
<td>2022-12-19 18:05</td>
<td>38.1</td>
</tr>
<tr>
<td>2022-12-19 18:44</td>
<td>37.8</td>
</tr>
<tr>
<td>2022-12-19 19:12</td>
<td>37.2</td>
</tr>
<tr>
<td>2022-12-19 19:47</td>
<td>37.8</td>
</tr>
<tr>
<td>2022-12-19 20:00</td>
<td>37.6</td>
</tr>
<tr>
<td>2022-12-19 21:09</td>
<td>37.2</td>
</tr>
<tr>
<td>2022-12-19 21:44</td>
<td>37.2</td>
</tr>
<tr>
<td>2022-12-19 22:57</td>
<td>36.9</td>
</tr>
<tr>
<td>2022-12-20 00:19</td>
<td>37.2</td>
</tr>
<tr>
<td>2022-12-20 06:55</td>
<td>37.1</td>
</tr>
<tr>
<td>2022-12-20 09:03</td>
<td>37.0</td>
</tr>
<tr>
<td>2022-12-20 09:34</td>
<td>37.0</td>
</tr>
<tr>
<td>2022-12-20 10:49</td>
<td>36.8</td>
</tr>
<tr>
<td>2022-12-20 11:41</td>
<td>38.0</td>
</tr>
<tr>
<td>2022-12-20 11:59</td>
<td>38.4</td>
</tr>
<tr>
<td>2022-12-20 14:47</td>
<td>38.6</td>
</tr>
<tr>
<td>2022-12-20 15:51</td>
<td>38.1</td>
</tr>
<tr>
<td>2022-12-20 16:32</td>
<td>38.0</td>
</tr>
<tr>
<td>2022-12-20 18:22</td>
<td>38.3</td>
</tr>
<tr>
<td>2022-12-20 22:31</td>
<td>38.4</td>
</tr>
<tr>
<td>2022-12-21 09:12</td>
<td>38.1</td>
</tr>
<tr>
<td>2022-12-21 09:59</td>
<td>38.2<code>*</code></td>
</tr>
<tr>
<td>2022-12-21 11:57</td>
<td>38.2</td>
</tr>
<tr>
<td>2022-12-21 13:46</td>
<td>37.5</td>
</tr>
<tr>
<td>2022-12-21 15:10</td>
<td>37.5</td>
</tr>
<tr>
<td>2022-12-21 16.44</td>
<td>37.2</td>
</tr>
<tr>
<td>2022-12-21 17:07</td>
<td>37.0</td>
</tr>
<tr>
<td>2022-12-21 20:37</td>
<td>37.2</td>
</tr>
<tr>
<td>2022-12-21 20:54</td>
<td>37.7</td>
</tr>
<tr>
<td>2022-12-21 22:54</td>
<td>38.3</td>
</tr>
<tr>
<td>2022-12-21 23:05</td>
<td>38.4</td>
</tr>
<tr>
<td>2022-12-22 09:23</td>
<td>36.7</td>
</tr>
<tr>
<td>2022-12-22 09:43</td>
<td>37.3</td>
</tr>
<tr>
<td>2022-12-22 12:44</td>
<td>37.6</td>
</tr>
</tbody>
</table>
<p><code>*</code>: 布洛芬已用完</p>
<p>可能大家只是看到一串冷冰冰的数字，但是我打字都是颤抖的，每一刻时间和体温都是刻骨铭心的记忆。</p>
<p>NEVER FORGET!</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-12-21T20:43:47+08:00">2023-12-21</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-18"  rel="bookmark" >
              <h2 class="card-title">京加高铁</h2>
            </a>
            <p class="card-text"><p>今天了解到这么一件事，白令海峡原来也就 82.5km 宽，水深55米，对于现代工程技术来说修桥和隧道都不是问题。</p>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/BeringSt-close-VE.jpg/600px-BeringSt-close-VE.jpg" /></p>
<p>如果中间那个岛做个中转站，那么两侧都各自30km左右。所以理论上从北京修一条到西雅图/加州的高铁完全没有问题。。</p>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/North_pole_map.jpeg/800px-North_pole_map.jpeg" /></p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-12-18T23:10:40+08:00">2023-12-18</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-17"  rel="bookmark" >
              <h2 class="card-title">query git notes with Github GraphQL</h2>
            </a>
            <p class="card-text"><p>git notes is an interesting feature, you can use it like </p>
<pre><code class="language-bash">git notes add -m &quot;hello test git notes&quot;
git push origin 'refs/notes/*'
</code></pre>
<p>Github supported them back <a href="https://github.blog/2010-08-25-git-notes-display/">in 2010</a> then gave up LMAO.</p>
<p>If you need to retrive them with Github API, try GraphQL like this</p>
<pre><code>  {
    repository(owner: "est", name: "snippets") {
      refs(refPrefix:"refs/notes/",first:1) {
        nodes{
          ... on Ref{
            target {
              oid
              ... on Commit{
                changedFilesIfAvailable
                message
                tree{
                  oid
                  entries{
                    oid
                    path
                    size
                    lineCount
                    mode
                    object{
                      ... on Blob{
                        byteSize
                        text
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
</code></pre>
<p>It will return something like:</p>
<pre><code>  {
    "data": {
      "repository": {
        "refs": {
          "nodes": [
            {
              "target": {
                "oid": "bfdfda121f3d8a2d6aa399e3e8f0d58b3db0a543",
                "changedFilesIfAvailable": 1,
                "message": "Notes added by 'git notes add'",
                "tree": {
                  "oid": "2ab3e6a8b0dff6596fa60ecfb3c61bf91e5b4e1f",
                  "entries": [
                    {
                      "oid": "404d353a254ffbc97b2e16d17b8c100461aef586",
                      "path": "4fb1272f1e235580f87e3ec071984658de050dc9",
                      "size": 21,
                      "lineCount": 1,
                      "mode": 33188,
                      "object": {
                        "byteSize": 21,
                        "text": "hello test git notes\n"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    }
  }
</code></pre>
<p>Here <code>"path": "4fb1272f1e235580f87e3ec071984658de050dc9"</code> is the commit SHA.</p>
<p>If you add more filter parameters in <code>refs()</code> you can fetch all the notes.</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-11-27T09:06:11+08:00">2023-11-27</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-16"  rel="bookmark" >
              <h2 class="card-title">VPS推荐：Hosteon</h2>
            </a>
            <p class="card-text"><p>继续<a href="/202012/stderr-012">上次 Racknerd</a> 之后发现这家还行。写了个<a href="https://github.com/est/snippets/blob/master/vps_scan/main.py">爬虫</a>扒了一下各色配置，独立服除外，有需要的自取</p>
<table>
<thead>
<tr>
<th>pid</th>
<th>spec</th>
<th>Disk</th>
<th>Bandwidth</th>
<th>Annual $</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=1">1</a></td>
<td>1C512M</td>
<td>5GB</td>
<td>100Mbps</td>
<td>$27.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=7">7</a></td>
<td>6C8G</td>
<td>100GB</td>
<td>100Mbps</td>
<td>$270.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=77">77</a></td>
<td>1C1G</td>
<td>10GB</td>
<td>1Tbps</td>
<td>$21.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=78">78</a></td>
<td>2C1.5G</td>
<td>20GB</td>
<td>2Tbps</td>
<td>$36.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=79">79</a></td>
<td>2C2G</td>
<td>25GB</td>
<td>3Tbps</td>
<td>$45.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=80">80</a></td>
<td>2C2.5G</td>
<td>30GB</td>
<td>4Tbps</td>
<td>$54.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=81">81</a></td>
<td>3C3G</td>
<td>40GB</td>
<td>5Tbps</td>
<td>$63.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=83">83</a></td>
<td>3C5G</td>
<td>50GB</td>
<td>8Tbps</td>
<td>$90.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=84">84</a></td>
<td>6C10G</td>
<td>120GB</td>
<td>12Tbps</td>
<td>$180.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=85">85</a></td>
<td>10C12G</td>
<td>150GB</td>
<td>15Tbps</td>
<td>$270.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=86">86</a></td>
<td>14C20G</td>
<td>200GB</td>
<td>20Tbps</td>
<td>$450.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=87">87</a></td>
<td>20C30G</td>
<td>300GB</td>
<td>30Tbps</td>
<td>$675.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=110">110</a></td>
<td>1C1G</td>
<td>15GB</td>
<td>2Tbps</td>
<td>$21.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=111">111</a></td>
<td>2C2G</td>
<td>20GB</td>
<td>4Tbps</td>
<td>$39.99</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=112">112</a></td>
<td>3C3G</td>
<td>30GB</td>
<td>6Tbps</td>
<td>$49.50</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=113">113</a></td>
<td>4C4G</td>
<td>40GB</td>
<td>8Tbps</td>
<td>$59.99</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=119">119</a></td>
<td>1C512M</td>
<td>10GB</td>
<td>500Gbps</td>
<td>$24.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=120">120</a></td>
<td>1C1G</td>
<td>15GB</td>
<td>1Tbps</td>
<td>$36.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=121">121</a></td>
<td>2C2G</td>
<td>30GB</td>
<td>2Tbps</td>
<td>$72.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=122">122</a></td>
<td>2C3G</td>
<td>50GB</td>
<td>3Tbps</td>
<td>$108.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=123">123</a></td>
<td>2C4G</td>
<td>70GB</td>
<td>4Tbps</td>
<td>$144.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=124">124</a></td>
<td>4C5G</td>
<td>90GB</td>
<td>5Tbps</td>
<td>$180.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=126">126</a></td>
<td>6C6G</td>
<td>100GB</td>
<td>6Tbps</td>
<td>$216.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=127">127</a></td>
<td>6C7G</td>
<td>120GB</td>
<td>7Tbps</td>
<td>$252.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=128">128</a></td>
<td>8C8G</td>
<td>140GB</td>
<td>8Tbps</td>
<td>$288.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=129">129</a></td>
<td>8C9G</td>
<td>150GB</td>
<td>9Tbps</td>
<td>$324.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=130">130</a></td>
<td>10C10G</td>
<td>170GB</td>
<td>10Tbps</td>
<td>$360.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=131">131</a></td>
<td>10C11G</td>
<td>180GB</td>
<td>11Tbps</td>
<td>$396.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=132">132</a></td>
<td>12C12G</td>
<td>200GB</td>
<td>12Tbps</td>
<td>$432.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=154">154</a></td>
<td>1C1G</td>
<td>20GB</td>
<td>4Tbps</td>
<td>$33.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=155">155</a></td>
<td>2C2G</td>
<td>30GB</td>
<td>6Tbps</td>
<td>$40.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=156">156</a></td>
<td>3C3G</td>
<td>40GB</td>
<td>8Tbps</td>
<td>$60.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=157">157</a></td>
<td>4C4G</td>
<td>50GB</td>
<td>10Tbps</td>
<td>$84.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=158">158</a></td>
<td>5C5G</td>
<td>60GB</td>
<td>12Tbps</td>
<td>$105.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=159">159</a></td>
<td>6C6G</td>
<td>70GB</td>
<td>14Tbps</td>
<td>$130.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=160">160</a></td>
<td>7C7G</td>
<td>80GB</td>
<td>16Tbps</td>
<td>$145.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=161">161</a></td>
<td>8C8G</td>
<td>90GB</td>
<td>18Tbps</td>
<td>$170.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=162">162</a></td>
<td>9C9G</td>
<td>100GB</td>
<td>20Tbps</td>
<td>$190.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=163">163</a></td>
<td>10C10G</td>
<td>110GB</td>
<td>22Tbps</td>
<td>$210.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=164">164</a></td>
<td>11C11G</td>
<td>120GB</td>
<td>24Tbps</td>
<td>$240.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=165">165</a></td>
<td>12C12G</td>
<td>130GB</td>
<td>26Tbps</td>
<td>$260.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=166">166</a></td>
<td>8C8G</td>
<td>50GB</td>
<td>30Tbps</td>
<td>$98.99</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=167">167</a></td>
<td>4C4G</td>
<td>25GB</td>
<td>15Tbps</td>
<td>$56.99</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=168">168</a></td>
<td>4C4G</td>
<td>25GB</td>
<td>15Tbps</td>
<td>$79.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=169">169</a></td>
<td>8C8G</td>
<td>50GB</td>
<td>30Tbps</td>
<td>$158.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=170">170</a></td>
<td>12C12G</td>
<td>75GB</td>
<td>30Tbps</td>
<td>$235.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=171">171</a></td>
<td>16C16G</td>
<td>100GB</td>
<td>30Tbps</td>
<td>$318.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=172">172</a></td>
<td>20C20G</td>
<td>125GB</td>
<td>30Tbps</td>
<td>$399.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=173">173</a></td>
<td>24C24G</td>
<td>150GB</td>
<td>30Tbps</td>
<td>$480.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=174">174</a></td>
<td>28C28G</td>
<td>175GB</td>
<td>30Tbps</td>
<td>$575.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=175">175</a></td>
<td>32C32G</td>
<td>200GB</td>
<td>30Tbps</td>
<td>$660.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=176">176</a></td>
<td>36C36G</td>
<td>225GB</td>
<td>30Tbps</td>
<td>$730.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=177">177</a></td>
<td>40C40G</td>
<td>250GB</td>
<td>30Tbps</td>
<td>$810.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=178">178</a></td>
<td>1C1G</td>
<td>20GB</td>
<td>2Tbps</td>
<td>$21.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=179">179</a></td>
<td>32C32G</td>
<td>1TB</td>
<td>1Gbps</td>
<td>$540.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=180">180</a></td>
<td>64C64G</td>
<td>1TB</td>
<td>1Gbps</td>
<td>$725.00</td>
</tr>
<tr>
<td><a href="https://my.hosteons.com/aff.php?aff=2128&amp;pid=181">181</a></td>
<td>128C128G</td>
<td>2x</td>
<td>1Gbps</td>
<td>$1850.00</td>
</tr>
</tbody>
</table></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-11-19T22:10:55+08:00">2023-11-19</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-15"  rel="bookmark" >
              <h2 class="card-title">太阳系天体的 unicode 符号</h2>
            </a>
            <p class="card-text"><p>发现<a href="https://en.wikipedia.org/wiki/Astronomical_symbols">Astronomical symbols</a>，<a href="https://en.wikipedia.org/wiki/Planet_symbols">Planet symbols<br />
</a> 及 <a href="https://en.wikipedia.org/wiki/Alchemical_symbol#Unicode">Alchemical symbol</a></p>
<table>
<thead>
<tr>
<th>IAU</th>
<th>七金</th>
<th>符号</th>
<th>名</th>
<th>name</th>
<th>星期</th>
<th>七曜</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>金</td>
<td>☉︎</td>
<td>太阳</td>
<td>Sun</td>
<td>星期天</td>
<td>日曜</td>
<td></td>
</tr>
<tr>
<td></td>
<td>银</td>
<td>☾</td>
<td>月球</td>
<td>Moon</td>
<td>星期一</td>
<td>月曜</td>
<td>也可以画成 ☽︎ <br>或者月相 🌑︎🌒︎🌓︎🌔︎🌕︎🌖︎🌗︎🌘︎，🌚︎🌛︎︎🌝︎︎🌜︎︎</td>
</tr>
<tr>
<td>H</td>
<td>汞</td>
<td>☿</td>
<td>水星</td>
<td>Mercury</td>
<td>星期三</td>
<td>水曜</td>
<td>赫耳墨斯(Hermes)，罗马人称 Mercury<br>现代人称「爱马仕」的双盘蛇带翼权杖 Caduceus <font size="5">☤</font></td>
</tr>
<tr>
<td>V</td>
<td>铜</td>
<td>♀</td>
<td>金星</td>
<td>Venus</td>
<td>星期五</td>
<td>金曜</td>
<td>维纳斯</td>
</tr>
<tr>
<td>E</td>
<td></td>
<td>🜨</td>
<td>地球</td>
<td>Earch</td>
<td></td>
<td></td>
<td><em>Bible</em> 里说的四条河把地球分成四洲<br>另外的符号是 ♁ 表示十字架钉个球 <em>globus cruciger</em></td>
</tr>
<tr>
<td>M</td>
<td>铁</td>
<td>♂</td>
<td>火星</td>
<td>Mars</td>
<td>星期二</td>
<td>火曜</td>
<td>符号是战神盾牌和长矛</td>
</tr>
<tr>
<td>J</td>
<td>锡</td>
<td>♃</td>
<td>木星</td>
<td>Jupiter</td>
<td>星期四</td>
<td>木曜</td>
<td>字母 Zeta（大写Ζ小写ζ）加一杠，代表宙斯/朱庇特</td>
</tr>
<tr>
<td>S</td>
<td>铅</td>
<td>♄</td>
<td>土星</td>
<td>Saturn</td>
<td>星期六</td>
<td>土曜</td>
<td>字母 kappa-rho ，表示 Kronos 加一杠<br>泰坦 克罗诺斯，宙斯他爹</td>
</tr>
<tr>
<td>U</td>
<td></td>
<td>⛢</td>
<td>天王星</td>
<td>Uranus</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>N</td>
<td></td>
<td>♅</td>
<td>海王星</td>
<td>Neptune</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>几点：</p>
<ul>
<li>其中 金星/火星 符号被拿来代表 女/男 是1750年代Carl Linnaeus干的。 </li>
<li>冥王星 Pluto 发现的晚，占星术还没来得及改版就惨遭除名成矮行星。</li>
<li>星期和对应的天体意义，<a href="https://en.wikipedia.org/wiki/Names_of_the_days_of_the_week">全世界惊人的一致</a></li>
</ul>
<p>其它各种卫星，小行星的名字就懒得贴了。</p>
<p>有了这些符号，我们可以画一个比如托勒密的简化版太阳系模型：</p>
<p><img alt="" src="/images/2023/stdout-15-01.jpg" /></p>
<p>本文源自《<a href="https://www.cricetuscricetus.co.uk/post/copernicus-galileo-kepler-they-all-lacked-proof">哥白尼、伽利略、开普勒都是脱离证据拍脑袋撕逼</a>》一文。<a href="https://news.ycombinator.com/item?id=38300902">HN</a></p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-11-18T16:15:51+08:00">2023-11-18</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-14"  rel="bookmark" >
              <h2 class="card-title">Getting started blogging on Win10</h2>
            </a>
            <p class="card-text"><p>I am planning to setup by blogging environment on my Windows PC.</p>
<ul>
<li>OS: Windows 10</li>
<li>Shell: Bash on WSL1</li>
<li>Program: <code>pelican</code> on Miniconda3 with Python 3.11</li>
</ul>
<p>My objective today is get rid of the <code>static/js/core.js</code> from <code>aether-pelican</code> theme and replace it with <a href="https://jsfiddle.net/t78mf7jb/3/">a simple CSS</a>, and it turns out quite challenging.</p>
<h3>WSL1 and file system</h3>
<p>As it turns out, the installed Ubuntu root filesystem on WSL1 is located here:</p>
<p><code>%localappdata%\Packages\CanonicalGroupLimited.UbuntuonWindows_79rhkp1fndgsc\LocalState\rootfs</code></p>
<p>I plan to move my home dir (at least) to another SSD on my PC, as the <code>C:\</code> drive is an old SanDisk Plus240, which is unforgivablly slow these days. I tried to <code>mv ~ /mnt/d/home</code>, ok but the permission gets weird.</p>
<p>So I tried to copy the folder on Windows to <code>D:\home</code>, and <code>mklink</code> back. I tried both <code>mklink /D</code> and <code>mklink /J</code> ( the <code>/D</code> switch works on a remote drive whereas the <code>/J</code> junction works on local NTFS disks only) and they both failed be recognized by WSL1. The bash yields <code>Broken stdout/stdin</code> upon launch</p>
<p>So OK, default home dir then. Bad luck for me.</p>
<h3>Ubuntu 22</h3>
<p>I just found out my <code>cat /etc/lsb-release</code> shows Ubuntu 18, which is the default distro installed on <code>WSL1</code> I assume. I tried to install Ubuntu 22 from the Microsoft Store, after several wasted minutes (curse the slow Internet in Mainland!) it turns out for WSL2 only. Luckily the Windows Subsystem for Linux was successfully upgraded to latest version:</p>
<pre><code>C:\&gt; wsl --version
WSL version: 1.2.5.0
Kernel version: 5.15.90.1
WSLg version: 1.0.51
MSRDC version: 1.2.3770
Direct3D version: 1.608.2-61064218
DXCore version: 10.0.25131.1002-220531-1700.rs-onecore-base2-hyp
Windows version: 10.0.19045.3570
</code></pre>
<p>the <code>wsl --list --online</code> commands stuck for a total of 10 minutes and returns nothing (curse the AS4134 163NET!)</p>
<h3>Getting Python, Miniconda and Pelican</h3>
<p>So linux distro setup was back to where started, I only have Python to mess with. Miniconda3 gets insalled easily, now that's a some progress. The static site generator I am using <code>pip install pelican[markdown]</code> finishes ok, the pypi was not blocked? Keke.</p>
<p>Then I typed <code>make</code>. It was not part of WSL1? Blaspheme!</p>
<p>Manually running <code>python -m pelican.server</code>, and voila! The Windows asks for firewall listening permission, granted, open up browser, BAM! My blog setup process is done and now I can write and tweak it on Windows. </p>
<p>Oh, and there's <code>git config core.fileMode false</code> needs to be checked!</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-11-11T10:31:11+08:00">2023-11-11</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-13"  rel="bookmark" >
              <h2 class="card-title">火星上怎么结算工资</h2>
            </a>
            <p class="card-text"><p>看到个段子</p>
<p><img alt="" src="/images/2023/stdout-13-01.jpg" /></p>
<p>突然让我想起个事，如果去火星打工，薪资该怎么计算？摘录 wikipedia</p>
<blockquote>
<p>火星的恒星时长 <code>24小时37分钟22.663秒</code>，而太阳日则长 <code>24小时39分钟35.24409</code> 秒。而地球的恒星时和太阳日则分别是 <code>23小时56分钟4.0916秒</code> 及 <code>24小时</code>。在比较之下，一火星太阳日等于1.027491地球太阳日，即比地球太阳日长2.7%。</p>
</blockquote>
<p>怎么有两个天？继续搜</p>
<blockquote>
<p>太阳日（英语：solar day）是依据太阳运动，所定义的时间，可以分为视觉太阳日和平均太阳日。一太阳日传统称为一“日”、一“天”或一“昼夜”。</p>
</blockquote>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/67/Sidereal_day_%28prograde%29.png/600px-Sidereal_day_%28prograde%29.png" /></p>
<p>英语里把火星的一天叫做一个 <code>Sol</code>。一个火星年在英文的 wikipedia 有讲</p>
<blockquote>
<p>sidereal year ... is about 686.98 Earth solar days (≈ 1.88 Earth years), or <code>668.5991</code> sols 。也就是说火星一年有 668.5991 火星天。。。</p>
</blockquote>
<p>火星因为有<code>25.19°</code>的自转倾角，跟地球相近，所以也可以划分四季。但问题是，火星的轨道长这样：</p>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Mars_earth_orbit.png/600px-Mars_earth_orbit.png" /></p>
<p>所以如果按照四个季节划分，最长的季节有 <code>194 个 Martian Sols</code>，最短的 <code>142 Martian sols</code></p>
<p>那么问题来了。在火星上怎么算工资呢？我觉得得安天结了。还有，假如亲爱的读者小伙伴将来到火星务工，应聘的时候一定确认好是按地球年结算还是火星年哦。谨防火星历诈骗！</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-11-09T15:50:11+08:00">2023-11-09</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-12"  rel="bookmark" >
              <h2 class="card-title">FastAPI/Starlette graceful shutdown server-sent events</h2>
            </a>
            <p class="card-text"><h3>缘起</h3>
<p>假如你用 FastAPI/Starlette框架，写了一段 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events">Server-sent Events</a></p>
<pre><code class="language-python">@app.get('/api/my_stream')
async def api_stream():
  async def gen():
    while 1:
      yield &quot;data: {}\n\n&quot;
      await asyncio.sleep(1.0)

  return StreamingResponse(gen, media_type=&quot;text/event-stream&quot;, headers={
    'X-Accel-Buffering': 'no',
    'Cache-Control': &quot;no-cache&quot;,
    'Connection': &quot;keep-alive&quot;,
  })
</code></pre>
<h3>FastAPI 事件</h3>
<p>然后你重启了服务器，比如 gunicorn+uvicorn，你会发现这个连接不会断开，一直输出结果。直到 worker 进程超过配置里的 <code>timeout</code> 参数（默认60秒），被 master 强行杀死然后重启。</p>
<p>一开始尝试了 <a href="https://fastapi.tiangolo.com/advanced/events/#shutdown-event">FastAPI 官方的 <code>shutdown</code> 事件</a>，再在代码的 <code>while 1</code> 加一个 <code>if</code> 判断。发现不管用</p>
<pre><code class="language-python">@app.on_event('shutdown')
def on_server_shutdown():
    app.state.running = False
</code></pre>
<p>发现这段代码执行是执行了，但是是在杀死worker的时候生效的。得更加提前。用<a href="https://asgi.readthedocs.io/en/latest/specs/lifespan.html">ASGI推荐的<code>lifespan</code></a>和 <a href="https://asgi.readthedocs.io/en/latest/specs/www.html#disconnect-receive-event"><code>http.disconnect</code></a> 太复杂，放弃。</p>
<h3>Linux signal</h3>
<p>尝试暴力监听 worker signal</p>
<pre><code class="language-python">import signal
signal.signal(signal.SIGINT, on_server_shutdown)  # ctrl+c
signal.signal(signal.SIGUSR2, on_server_shutdown)
signal.signal(signal.SIGTERM, on_server_shutdown)
signal.signal(signal.SIGWINCH, on_server_shutdown)
signal.signal(signal.SIGHUP, on_server_shutdown)
signal.signal(signal.SIGQUIT, on_server_shutdown)
</code></pre>
<p>发现也不管用。研究了半天，似乎是 <code>UvicornWorker.init_signals</code> 的时候<a href="https://github.com/encode/uvicorn/issues/894">给<code>signal.SIG_DFL</code>了</a>。无语ing</p>
<h3>uvicorn shutdown 流程</h3>
<p>看gunicorn日志：</p>
<pre><code>[2023-11-02 09:50:38 +0800] [25918] [INFO] Shutting down
[2023-11-02 09:50:38 +0800] [25918] [INFO] Waiting for application shutdown.
[2023-11-02 09:50:38 +0800] [25918] [INFO] Waiting for connections to close. (CTRL+C to force quit)
....
[2023-11-02 09:51:18 +0800] [25918] [INFO] Application shutdown complete.
[2023-11-02 09:51:18 +0800] [25918] [INFO] Finished server process [25918]
[2023-11-02 09:51:18 +0800] [25918] [INFO] Worker exiting (pid: 25918)
</code></pre>
<p>观察到 Waiting for connections to close 之后卡住。</p>
<p>属于 uvicorn 的 <a href="](https://github.com/encode/uvicorn/blob/07c2b36455b5475ff7edfa54068ff2c0581a2be1/uvicorn/server.py#L303)"><code>Server.shutdown()</code></a> 方法</p>
<p>这个方法调用链：</p>
<ol>
<li><code>Server.install_signal_handlers</code> 里注册 signal </li>
<li><code>Server.handle_exit</code> 里设置 <code>Server.should_exit = True</code></li>
<li>每秒一次的 <code>Server.on_tick</code> 就会打断 <code>Server.main_loop()</code> 死循环</li>
<li>调用 <code>Server.shutdown</code></li>
</ol>
<p>如果能拿到 <code>Server.should_exit</code> 自行判断就好了，但是 ASGI 是容器无感的，只继续研究</p>
<h3>断开http连接</h3>
<p>上面日志有一个比较关键：</p>
<pre><code class="language-python"># Request shutdown on all existing connections.
for connection in list(self.server_state.connections):
    connection.shutdown()
    await asyncio.sleep(0.1)
</code></pre>
<p>其http连接关闭方法实现为：</p>
<pre><code class="language-python">def shutdown(self):
    &quot;&quot;&quot;
    Called by the server to commence a graceful shutdown.
    &quot;&quot;&quot;
    if self.cycle is None or self.cycle.response_complete:
        self.transport.close()
    else:
        self.cycle.keep_alive = False
</code></pre>
<p>这里应该走的是 <code>else</code> 分支。所以解决方法就是去代码里拿到 <code>cycle.keep_alive</code> 这个属性。</p>
<h3>ASGI 接口</h3>
<p>跟了一会儿，发现ASGI 在  starlette 里如下流程：</p>
<ol>
<li><code>Route()</code> 初始化 <code>self.app = request_response(endpoint)</code></li>
<li><code>Route().handle()</code> 的时候会调用 <code>self.app(scope, receive, send)</code></li>
<li><code>unicorn</code> 的 <code>run_asgi</code> 会 <code>result = await app(self.scope, self.receive, self.send)</code> 。其中 <code>app</code> 就是 starlette 的 <code>Route()</code> 实例</li>
</ol>
<p>所以解决方案逐渐明朗了</p>
<h3>黎明的前夜</h3>
<p>通过 FastAPI/Starlette 请求的 <code>.receive</code> 属性的 <code>__self__</code> 拿到 unicorn 的 <code>cycle</code> 实例，然后定时判断上面 <code>shutdown</code> 赋值的 <code>self.cycle.keep_alive = False</code></p>
<pre><code class="language-python">@app.get('/api/my_stream')
async def api_stream(req: Request):
  async def gen():
    while 1:
      yield &quot;data: {}\n\n&quot;
      await asyncio.sleep(1.0)
      if getattr(req.receive.__self__, 'keep_alive', None) is False:
        break

  return StreamingResponse(...
</code></pre>
<p>这里用了个 <code>getattr()</code> 是保证这个 hack 在非 unicorn 下代码也能正常跑</p>
<p><code>git commit . -m "haha"</code> 上机联调，发现坑了。。。我特么。。。。这个 <code>cycle.keep_alive</code> 默认就是 <code>False</code></p>
<h3>扭转 keep_alive</h3>
<p>这玩意一直为 <code>False</code> 的原因是，unicorn 的 <code>HttpToolsProtocol.on_headers_complete</code> 赋值过程：</p>
<p><code>self.cycle = RequestResponseCycle(..., keep_alive=http_version != "1.0")</code></p>
<p>这里 <code>http_version</code> 可以通过  <code>req.scope['http_version']</code> 得到，打印了一下，你猜怎么着，还真tm是。。。原因就是厂里反代 <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_http_version">nginx的proxy_http_version</a>没配置。这里是个常见的坑，非常影响性能，因为每个请求会生成一个新的 http 连接。</p>
<p>但是也等不急SA去改配置了。于是直接在代码 <code>async def gen():</code> 前面写死：</p>
<p><code>req.receive.__self__.keep_alive = True</code> 。提交，再试。。。咦，怎么 <code>keep_alive</code> 依然为 <code>False</code>？？？？明明刚刚赋值了？</p>
<p>继续读代码，发现第二个坑，发现 unicorn 的 <code>RequestResponseCycle.send()</code> 方法里，在构造返回的时候，有一句</p>
<pre><code class="language-python">for name, value in headers:
    elif name == b&quot;connection&quot; and value.lower() == b&quot;close&quot;:
        self.keep_alive = False
</code></pre>
<p>好吧。。。那么解决方法就是，把 <code>keep_alive = True</code> 挪到返回内部。先完成返回构造，再强行改值。</p>
<h4>最后的代码</h4>
<pre><code class="language-python">@app.get('/api/my_stream')
async def api_stream(req: Request):
  # req.receive.__self__.keep_alive = True  # doesn't work here
  async def gen():
    req.receive.__self__.keep_alive = True  # works here
    while 1:
      yield &quot;data: {}\n\n&quot;
      await asyncio.sleep(1.0)
      if req.receive.__self__.keep_alive is False:
        break

  return StreamingResponse(gen, media_type=&quot;text/event-stream&quot;, headers={
    'X-Accel-Buffering': 'no',
    'Cache-Control': &quot;no-cache&quot;,
    'Connection': &quot;keep-alive&quot;,
  })
</code></pre>
<p>测试重启 worker，该连接在1秒后断开，worker平稳重启。完美。</p>
<p>苦逼撸业务的一天又开始了。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-11-02T09:44:12+08:00">2023-11-02</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-11"  rel="bookmark" >
              <h2 class="card-title">浏览器拉起钉钉客户端并跳转OA工单</h2>
            </a>
            <p class="card-text"><p>又是 corporate software engineering 吃屎的一天。用户在内部系统走流程，厂里用的是钉钉自带的OA工单审批。已经接入了API创建、完成工单</p>
<p>问题在于发起工单之后，用户并没有感知，不知道工单去哪里了，流程就断了，向钉钉官方售后发起咨询，对方丢了一句：不支持。无语</p>
<p>只能自己鼓捣。已知工单链接，在钉钉聊天窗口内部的最短的网址为：</p>
<pre><code>  https://aflow.dingtalk.com/dingtalk/mobile/homepage.htm?corpid=...&amp;procInstId=...#approval
</code></pre>
<p>对方丢了一个 <a href="https://open.dingtalk.com/document/isvapp/webapp-unified-routing-protocol#title-kkq-kgx-lbq">dingtalk:// 跳转协议</a></p>
<p>反复尝试，发现一个很有用：</p>
<blockquote>
<p>桌面端打开URL <br />
<code>dingtalk://dingtalkclient/page/link</code> <br />
侧边栏： <code>pc_slide=true</code> <br />
大容器（类似工作台容器）<code>ddtab=true</code>   </p>
</blockquote>
<p>于是构造一个试试：</p>
<pre><code>  dingtalk://dingtalkclient/page/link?url=https%3A%2F%2Faflow.dingtalk.com%2Fdingtalk%2Fpc%2Fquery%2Fpchomepage.htm%3Fcorpid%3D...%26procInstId%3D...%23%2Fapproval
</code></pre>
<p>然后果然ok了。</p>
<p>钉钉给人的感觉就是各个部门 hack 强行揉合起来一个怪物。各种不完善、不一致的问题。有空写一下吐槽。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-10-18T14:57:00+08:00">2023-10-18</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-10"  rel="bookmark" >
              <h2 class="card-title">SVG放在 img 中不能加载图片/字体</h2>
            </a>
            <p class="card-text"><p>最近想在 markdown 里搞图文混排，遇到一个大图把版面占完了，想缩小一些，由于 .md 渲染器安全限制，没法直接指定宽高</p>
<p>只能从图片本身想办法，首先最直接的手段就是服务器再缩放一次，但是蛋痛的问题是缩放之后文件怎么存，怎么给静态文件路由，怎么保障图片可用性，怎么兼容各种尺寸，想想都头大。</p>
<p>想到一个 hack，要不直接放一个 .svg 进去，因为 svg 支持加载位图资源，所以把 svg 位图缩小一点，让浏览器渲染 svg 不就行了。</p>
<p>没想到就被这个 hack 坑了。原因是 svg 如果被 <code>&lt;img&gt;</code> 标签渲染，那么禁止加载任何外部资源，脚本也禁止执行。</p>
<p>为了证明这个限制，我写了个 demo 放在 <a href="https://lab.est.im/shit_svg/">https://lab.est.im/shit_svg/</a></p>
<p>这个问题太隐蔽了。stackoverflow 上只有 <a href="https://stackoverflow.com/a/30467585/41948">Robert Longson</a>、<a href="https://stackoverflow.com/a/69160093/41948">ThangLeQuoc</a>、<a href="https://stackoverflow.com/a/18244035/41948#18244035">TheHippo<br />
</a> 的答案提到隐约线索：</p>
<p>后来搜了到 <a href="https://supercodepower.com/en/svg-img-use-font">skychx</a> 把这个问题研究透了。罪魁祸首 <a href="https://www.w3.org/wiki/SVG_Security">SVG Security</a></p>
<blockquote>
<p>If an SVG file is fetched as image, then certain requirements apply to this document:   </p>
<ul>
<li>The SVG document is not allowed to fetch any resources. This also applies to scripts, stylesheets or images.   </li>
<li>Fonts shouldn't be loaded as well. The situation in UAs seems to still be unclear though.<br />
Scripts must not be executed.   </li>
<li>Event listeners must be disabled at all times.   </li>
</ul>
</blockquote>
<p>浪费我好多时间。SVG2里把这个说得很明白了 <a href="https://www.w3.org/TR/SVG2/conform.html#processing-modes">https://www.w3.org/TR/SVG2/conform.html#processing-modes</a></p>
<blockquote>
<p>When external references are disabled in an SVG document, any attempt to fetch a document through an external reference must instead be treated as if a network error occurred and no data was received.</p>
</blockquote>
<p>不过查阅资料的时候发现个好玩的，<a href="https://www.w3.org/TR/SVG11/single-page.html#linking-LinksIntoSVG">SVG 1.1 支持 URL fragments</a></p>
<p>比如：</p>
<ul>
<li>原图 <a href="https://lab.est.im/shit_svg/1.svg">https://lab.est.im/shit_svg/1.svg</a> <embed src="https://lab.est.im/shit_svg/1.svg"></li>
<li>放大 <a href="https://lab.est.im/shit_svg/1.svg#svgView(viewBox(20,20,60,60))">https://lab.est.im/shit_svg/1.svg#svgView(viewBox(20,20,60,60))</a> <embed src="https://lab.est.im/shit_svg/1.svg#svgView(viewBox(20,20,60,60))"></li>
</ul></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-10-17T22:13:18+08:00">2023-10-17</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-09"  rel="bookmark" >
              <h2 class="card-title">市以上行政区划去掉后缀</h2>
            </a>
            <p class="card-text"><p>今天才知道，中国一共333个市一级行政单位。数据来源是 <a href="https://www.mca.gov.cn/n156/index.html">民政部首页 ➡ 民政数据</a></p>
<pre><code>import re

def short_name(name):
    m = re.search(r'''
        (\S+?)
        (?:
            壮族|回族|维吾尔|省|自治区|特别|  # 省
            (?:侗|傈僳|傣|哈尼|回|土家|壮|布依|彝|景颇|朝鲜|白|羌|苗|藏)族|
            蒙古|柯尔克孜|哈萨克|
            地区|市|盟|自治州|自治县
        ).*$
    ''', name, re.VERBOSE)
    if m:
        return m.group(1)
    return name
</code></pre>
<p>这段代码的作用是把比如 <code>"黔南布依族苗族自治州"</code> 这样的名字，缩短成 <code>"黔南"</code>。</p>
<p>有一个小坑是，市一级行政区包含 <code>蒙古|柯尔克孜|哈萨克</code> 这三个名字后面没有 <code>族</code> 字。</p>
<p>有一些 <code>XX林区</code> <code>XX矿区</code> 什么的，我觉得保留比较好。</p>
<p>Python的 <code>re.VERBOSE</code> 真是好东西！</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-10-12T20:01:23+08:00">2023-10-12</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-07"  rel="bookmark" >
              <h2 class="card-title">在py3里同步/异步混合使用 httpx 调用</h2>
            </a>
            <p class="card-text"><p>比如开发需求是请求一个 http API，得到数据，解析一下返回，那么一般的做法是封装一个方法，比如</p>
<pre><code>import httpx


def get_sth(p1, default=MY_VAL):
    # network
    r = httpx.get(API_URL, params={'t1': p1})
    # parsing
    res = r.json().get('my_key') or MY_VAL
</code></pre>
<p>但是如果想在 async/await 里用这段代码，就得改成</p>
<pre><code>import httpx


async def get_sth(p1, default=MY_VAL):
    # network
    with http.AsyncClient() as client:
        r = await client.get(API_URL, params={'t1': p1})
    # parsing
    res = r.json().get('my_key') or MY_VAL
</code></pre>
<p>注意其中 <code>def get_sth()</code> 也必须改成 <code>async def get_sth</code> 。这就是所谓 async/await 传染性</p>
<p>这个时候，如果你想把这块代码抽象出来，让同步/异步的库都能调用，我在最近重构里找到一个最佳实践：</p>
<pre><code>import httpx


def get_sth(p1, default=MY_VAL):
    r = httpx.Request('GET', API_URL, params={'t1': p1})
    r.parse = lambda x: (x.get('my_key') or MY_VAL)

# 同步调用：
with httpx.Client() as client:
    r = client.send(get_sth())
r.request.parse(r.json())

# 异步调用：
async with httpx.AsyncClient() as client:
    r = await client.send(get_sth())
r.request.parse(r.json())
</code></pre>
<p>思路是 逻辑和 transport解耦，也是某种意义上的 <a href="https://sans-io.readthedocs.io/">Sans-IO</a> 了吧？</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-07-05T17:39:54+08:00">2023-07-05</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-06"  rel="bookmark" >
              <h2 class="card-title">git切换马甲</h2>
            </a>
            <p class="card-text"><p>如果你有多个 github、bitbucket、gitlab 账号需要来回切换，那么这个方法或许对你有用。</p>
<p>使用git你需要配置一个 <code>~/.ssh/id_rsa</code>，如果你有多个身份就麻烦了。传统网上搜到的办法是编辑 <code>~/.ssh/config</code> 然后加入个类似这样的配置：</p>
<pre><code>  Host estgit
  HostName github.com
  Port 22
  User git
  IdentityFile ~/.ssh/est_github
  IdentitiesOnly yes
</code></pre>
<p>这样做也不是不行，就是你输入命令的时候得把主机名改了。比如</p>
<p><code>git clone git@github.com:est/aether-pelican.git</code></p>
<p>你需要改成 </p>
<p><code>git@estgit:est/aether-pelican.git</code></p>
<p>当然这还不是最蛋痛的。最蛋痛的是如果你用了 <code>git submodules</code> 那么你切换马甲变得非常麻烦。因为别人用你的项目没法解析 <code>git@estgit</code> 这样的玩意。</p>
<p>我研究出来了一个hack，直接改repo的 <code>.git/config</code> 可以达到同样的效果。比如</p>
<pre><code>  [core]
      sshCommand = /usr/bin/ssh -o IdentitiesOnly=yes -i ~/.ssh/est_github -a
  [user]
      name = est
      email = ...@...
</code></pre>
<p>这样你可以随意在不同的repo切换n个 ssh identity 身份。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-06-26T16:27:28+08:00">2023-06-26</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-08"  rel="bookmark" >
              <h2 class="card-title">Rimworld 1.4 Biotech Xenogene/Endogene code names</h2>
            </a>
            <p class="card-text"><p>I found out the corresponding gene code by accident, for Yuran Race mod it's located under</p>
<p><code>~/Library/Application\ Support/Steam/SteamApps/workshop/content/*/2844129100/Bio1.4/Defs/YuranBioTitle.xml</code></p>
<p>So the official description can be found at (or <a href="https://rimworldwiki.com/wiki/Modding_Tutorials/Xenotypes">wiki</a>):</p>
<p><code>~/Library/Application\ Support/Steam/SteamApps/common/RimWorld/RimWorldMac.app/Data/Biotech/Defs/GeneDefs/</code></p>
<p>I need to use the dev tool to modify gene of my pawn, so here's the table:</p>
<pre><code>import os
import xml.etree.ElementTree as ET
p = os.path.expanduser('~/Library/Application Support/Steam/SteamApps/common/RimWorld/RimWorldMac.app/Data/Biotech/Defs/GeneDefs/')
fields = 'defName label description biostatCpx biostatMet biostatArc'.split()
print('| %s |' % ' | '.join(fields))
print('|--------' * len(fields) + '|')
for f in os.listdir(p):
    root = ET.fromstring(open(p + f).read())
    for elem in root.findall('GeneDef'):
        vals = [t.text if isinstance(t:=elem.find(x), ET.Element) else '' for x in fields]
        if vals[0]:
            print('| %s |' % ' | '.join(vals))
</code></pre>
<p>The result is:</p>
<style type="text/css" id="pre-table">
    style#pre-table + table{
        font-size: 65%;
    }
</style>

<table>
<thead>
<tr>
<th>defName</th>
<th>label</th>
<th>description</th>
<th>biostatCpx</th>
<th>biostatMet</th>
<th>biostatArc</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hair_BaldOnly</td>
<td>no hair</td>
<td>Carriers of this gene grow no hair on the head.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Hair_ShortOnly</td>
<td>short-haired</td>
<td>Carriers of this gene can only grow short hair.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Hair_LongOnly</td>
<td>long-haired</td>
<td>Carriers of this gene grow hair on the head very quickly.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Hair_Grayless</td>
<td>grayless hair</td>
<td>Carriers of this gene keep their natural hair color as they age.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Beard_BushyOnly</td>
<td>only bushy beards</td>
<td>Male carriers of this gene experience rapid beard growth and are uncomfortable cutting their beards.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Beard_NoBeardOnly</td>
<td>beardless</td>
<td>Carriers of this gene grow no facial hair.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Beard_Always</td>
<td>unisex beards</td>
<td>Carriers of this gene always have thick facial hair, even women.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_InkBlack</td>
<td>ink black skin</td>
<td>Carriers of this gene produce a pigment that turns their skin a pale black color almost as dark as ink.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_SlateGray</td>
<td>slate gray skin</td>
<td>Carriers of this gene produce a pigment that turns their skin slate gray.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_LightGray</td>
<td>light gray skin</td>
<td>Carriers of this produce a light-gray pigment in their skin.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_SheerWhite</td>
<td>sheer white skin</td>
<td>Carriers of this gene have sheer white skin, unlike natural skin tones, due to a special engineered reflective cell covering.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_Blue</td>
<td>blue skin</td>
<td>Carriers of this gene produce a pigment that turns their skin a blue color.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_Purple</td>
<td>purple skin</td>
<td>Carriers of this gene produce a pigment that gives their skin a purple color.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_PaleRed</td>
<td>pale red skin</td>
<td>Carriers of this gene produce a pigment that turns their skin a moderate red color.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_DeepRed</td>
<td>deep red skin</td>
<td>Carriers of this gene produce a deep-red pigment that gives their skin an almost bloody appearance.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_PaleYellow</td>
<td>pale yellow skin</td>
<td>Carriers of this gene produce a pigment that turns their skin a grayish yellow color.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_DeepYellow</td>
<td>deep yellow skin</td>
<td>Carriers of this gene produce a pigment that gives their skin a deep yellow color.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_Orange</td>
<td>orange skin</td>
<td>Carriers of this gene produce a pigment that gives their skin an orange color.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Skin_Green</td>
<td>green skin</td>
<td>Carriers of this gene produce a pigment that gives their skin a green color.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Furskin</td>
<td>furskin</td>
<td>Carriers of this gene grow thick fur all over their body, which protects them from cold temperatures.</td>
<td>1</td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>Eyes_Red</td>
<td>red eyes</td>
<td>Carriers of this gene have deeply red-pigmented eyes.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Eyes_Gray</td>
<td>gray eyes</td>
<td>Carriers of this gene have pale white-gray eyes.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Brow_Heavy</td>
<td>heavy brow</td>
<td>Carriers of this gene have a prominent brow.</td>
<td>0</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Tail_Furry</td>
<td>furry tail</td>
<td>Carriers of this gene grow a fluffy tail which partially protects them from cold temperatures.</td>
<td>1</td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>Tail_Smooth</td>
<td>smooth tail</td>
<td>Carriers of this gene grow a slender tail that can act as a dexterous fifth limb.</td>
<td>1</td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>FacialRidges</td>
<td>facial ridges</td>
<td>Carriers of this gene grow raised ridges of skin on their face.</td>
<td>0</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MinTemp_SmallIncrease</td>
<td>cold weakness</td>
<td>Carriers of this gene are slightly less comfortable in cold temperatures.</td>
<td></td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>MinTemp_SmallDecrease</td>
<td>cold tolerant</td>
<td>Carriers of this gene are slightly more comfortable in cold temperatures.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>MinTemp_LargeDecrease</td>
<td>cold super-tolerant</td>
<td>Carriers of this gene are much more comfortable in cold temperatures.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>MaxTemp_LargeIncrease</td>
<td>heat super-tolerant</td>
<td>Carriers of this gene are more comfortable in warm temperatures.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>MaxTemp_SmallIncrease</td>
<td>heat tolerant</td>
<td>Carriers of this gene are slightly more comfortable in warm temperatures.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>MaxTemp_SmallDecrease</td>
<td>heat weakness</td>
<td>Carriers of this gene are slightly less comfortable in warm temperatures.</td>
<td></td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>PsychicAbility_Deaf</td>
<td>psychically deaf</td>
<td>Carriers of this gene are deaf to all psychic energy and influence outside their own minds. They cannot be affected by psychic influence, nor can they ever wield psychic power.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>PsychicAbility_Dull</td>
<td>psychically dull</td>
<td>Carriers of this gene are less psychically-sensitive than others.</td>
<td></td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>PsychicAbility_Enhanced</td>
<td>psy-sensitive</td>
<td>Carriers of this gene are more psychically-sensitive than average.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>PsychicAbility_Extreme</td>
<td>super psy-sensitive</td>
<td>Carriers of this gene are much more psychically-sensitive than most.</td>
<td>2</td>
<td>-5</td>
<td></td>
</tr>
<tr>
<td>MoveSpeed_Slow</td>
<td>slow runner</td>
<td>Carriers of this gene move more slowly than normal.</td>
<td></td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>MoveSpeed_Quick</td>
<td>fast runner</td>
<td>Carriers of this gene move more quickly than normal.</td>
<td></td>
<td>-3</td>
<td></td>
</tr>
<tr>
<td>MoveSpeed_VeryQuick</td>
<td>very fast runner</td>
<td>Carriers of this gene move much more quickly than normal.</td>
<td></td>
<td>-5</td>
<td></td>
</tr>
<tr>
<td>Beauty_VeryUgly</td>
<td>very unattractive</td>
<td>Carriers of this gene have misshapen, asymmetrical facial structures and blotchy skin. They're hard to look at.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>Beauty_Ugly</td>
<td>unattractive</td>
<td>Carriers of this gene have exaggerated facial features and poor skin that are generally considered ugly.</td>
<td></td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>Beauty_Pretty</td>
<td>attractive</td>
<td>Carriers of this gene have unusually symmetrical, balanced facial features and extra-clear skin which gives them a pleasing appearance.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>Beauty_Beautiful</td>
<td>very attractive</td>
<td>Carriers of this gene have remarkably precise and symmetrical faces. Their features are distinctive and strong without being exaggerated, and their skin is nearly perfect. They are generally seen as beautiful.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>Learning_Slow</td>
<td>slow study</td>
<td>Carriers of this gene have deficient long-term memories and don't understand new ideas quickly. They are slow at learning new skills and knowledge.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>Learning_Fast</td>
<td>quick study</td>
<td>Carriers of this gene have excellent memories and grasp new ideas quickly. They learn faster than others.</td>
<td>2</td>
<td>-3</td>
<td></td>
</tr>
<tr>
<td>Mood_Depressive</td>
<td>very unhappy</td>
<td>Carriers of this gene are highly predisposed to negative emotion. They'll see the bad in every situation and have a much lower mood than others.</td>
<td></td>
<td>5</td>
<td></td>
</tr>
<tr>
<td>Mood_Pessimist</td>
<td>unhappy</td>
<td>Carriers of this gene are predisposed to pessimistic perceptions. They'll tend to interpret things negatively and have lower mood than others.</td>
<td></td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>Mood_Optimist</td>
<td>happy</td>
<td>Carriers of this gene are predisposed to optimistic feelings. They'll have higher mood than others.</td>
<td>2</td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>Mood_Sanguine</td>
<td>very happy</td>
<td>Carriers of this gene are highly predisposed to optimism and not at all inclined to think negatively. They'll have much higher mood than others.</td>
<td>3</td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>ToxResist_Partial</td>
<td>tox resistance</td>
<td>Carriers of this gene are resistant to toxic buildup from any source. This includes pollution, toxic fallout, tox gas, and direct attacks with venom or injected poison. They'll gain half the amount of toxic buildup compared to others.\n\nCellular filters in the lung and skin reduce the dose of toxins entering the bloodstream.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>ToxResist_Total</td>
<td>tox immunity</td>
<td>Carriers of this gene are totally immune to toxic buildup from all sources including polluted terrain, toxic fallout, tox gas, and direct attacks with venom or injected poison. They are also not bothered by acidic smog.\n\nThe carrier's biochemical pathways are modified to route around interference from nearly all known toxins. Along with enhancements to the kidneys and liver, this keeps carriers comfortable in even the most toxic of environments.</td>
<td>2</td>
<td>-4</td>
<td></td>
</tr>
<tr>
<td>Delicate</td>
<td>delicate</td>
<td>Carriers of this gene take greater injuries than others from the same damage. They have thin, brittle bones and less binding molecules in joints and flesh.</td>
<td></td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>Robust</td>
<td>robust</td>
<td>Carriers of this gene take less injuries than others from the same damage. They have thickened, densified bones, nearly-solid ribcages, and strengthened binding factors in joints and flesh.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>Pain_Reduced</td>
<td>reduced pain</td>
<td>Carriers of this gene feel half as much pain compared to a baseliner. Reduced neuron activity in the brain's nociception centers makes pain dull and faint. This can be advantageous sometimes, and dangerous other times.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>Pain_Extra</td>
<td>extra pain</td>
<td>Carriers of this gene feel more pain than others given the same injuries. Neuron activity in the brain's nociception center is amplified, so pain feels extra-intense and fiery. This can be protective, but overall it's considered a negative and makes it hard to push through difficult situations.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>Aggression_DeadCalm</td>
<td>dead calm</td>
<td>Carriers of this gene feel calm in every situation and have a very placid demeanor. They will never start social fights or have aggressive mental breaks.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>Aggression_Aggressive</td>
<td>aggressive</td>
<td>Carriers of this gene are quick to anger. They are twice as likely to start social fights. When they have mental breaks, they are twice as likely to choose an aggressive kind of break.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>Aggression_HyperAggressive</td>
<td>hyper-aggressive</td>
<td>Carriers of this gene are hormonally high-strung and very aggressive. They are three times as likely to start social fights. Any mental break they have will be of an aggressive type.</td>
<td></td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>VerySleepy</td>
<td>very sleepy</td>
<td>Carriers of this gene get tired much faster than others.</td>
<td></td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>Sleepy</td>
<td>sleepy</td>
<td>Carriers of this gene get tired somewhat faster than others.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>LowSleep</td>
<td>low sleep</td>
<td>Carriers of this gene get tired less quickly than others.</td>
<td>2</td>
<td>-4</td>
<td></td>
</tr>
<tr>
<td>Neversleep</td>
<td>never sleep</td>
<td>Carriers of this gene have a unique metabolic process which allows clusters of neurons to sleep while the rest of the brain stays awake. They never need to sleep.</td>
<td>3</td>
<td>-6</td>
<td></td>
</tr>
<tr>
<td>MeleeDamage_Weak</td>
<td>weak melee damage</td>
<td>Carriers of this gene do less damage in close-quarters combat. Weak fast-twitch muscle fibers make their strikes shaky and weak.</td>
<td></td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>MeleeDamage_Strong</td>
<td>strong melee damage</td>
<td>Carriers of this gene do more damage in close-quarters combat. Extra-strong fast-twitch muscle fibers make their strikes accurate and powerful.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>UVSensitivity_Mild</td>
<td>mild UV sensitivity</td>
<td>Carriers of this gene have biological compounds in their skin that react painfully to UV radiation. They are unusually sensitive to sunlight.</td>
<td></td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>UVSensitivity_Intense</td>
<td>intense UV sensitivity</td>
<td>Carriers of this gene have biological compounds in their skin that react dangerously to UV radiation. They are intensely sensitive to sunlight.</td>
<td>2</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>Libido_Low</td>
<td>low libido</td>
<td>Carriers of this gene are less likely to engage in lovin' with their partner.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Libido_High</td>
<td>high libido</td>
<td>Carriers of this gene are more likely to engage in lovin' with their partner.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>FireSpew</td>
<td>fire spew</td>
<td>Carriers are able to spew flammable bile generated by a special organ in their neck. The bile sticks to anything in a small area and can ignite people, objects, and the ground.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>FoamSpray</td>
<td>foam spray</td>
<td>Carriers grow glands in the neck that generate and store a fire-retardant foam. They can spew this foam over an area to extinguish fires.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>LongjumpLegs</td>
<td>longjump legs</td>
<td>Carriers have special hemogen-powered muscle fibers in their legs which allow them to jump great distances.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>AnimalWarcall</td>
<td>animal warcall</td>
<td>Carriers of this gene can perform an animal warcall, using a powerful bellow and psychic connection to call an animal to fight for them.</td>
<td>1</td>
<td>-3</td>
<td></td>
</tr>
<tr>
<td>Bloodfeeder</td>
<td>bloodfeeder</td>
<td>Carriers of this gene have small retractable fangs and an organ on the roof of the mouth which can extract hemogen from fresh warm blood. They can bite an unresisting person, suck the blood, and gain hemogen directly.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>Coagulate</td>
<td>coagulate</td>
<td>Carriers of this gene have special glands on their hands and wrists, as well as a unique salivary compound that they can use to rapidly tend wounds.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>XenogermReimplanter</td>
<td>gene implanter</td>
<td>Carriers of this gene can implant a copy of their xenogerm into another person through a somewhat gross-looking injector organ. Their own genetic material will then regrow very slowly. If they implant while their genes are regrowing, they will die. Germline genes will be unaffected.</td>
<td>3</td>
<td></td>
<td>1</td>
</tr>
<tr>
<td>PiercingSpine</td>
<td>piercing spine</td>
<td>Carriers grow an opening in their upper chest along with a quiver of keratin spines. Using a hemogen-powered chemical reaction, they can fire these spines at high speed at nearby targets with surprising accuracy.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>AcidSpray</td>
<td>acid spray</td>
<td>Carriers grow glands in the neck that generate and store a sticky acid substance, along with acid-tolerant tissues in the mouth. They can spew this acid over an area, where it will stick to enemies and burn them over time.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>Body_Fat</td>
<td>fat body</td>
<td>Carriers can have fat bodies. A person can have more than one body type gene; one body type will be chosen among those that are allowed.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Body_Thin</td>
<td>thin body</td>
<td>Carriers can have thin bodies. A person can have more than one body type gene; one body type will be chosen among those that are allowed.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Body_Hulk</td>
<td>hulk body</td>
<td>Carriers can have large bodies. A person can have more than one body type gene; one body type will be chosen among those that are allowed.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Body_Standard</td>
<td>standard body</td>
<td>Carriers can have average-shaped bodies. A person can have more than one body type gene; one body type will be chosen among those that are allowed.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ears_Human</td>
<td>human ears</td>
<td>Carriers of this gene have regular human ears.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ears_Pig</td>
<td>pig ears</td>
<td>Carriers of this gene will grow pointed pig-like ears.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ears_Floppy</td>
<td>floppy ears</td>
<td>Carriers of this gene grow long, floppy hound-like ears.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ears_Cat</td>
<td>cat ears</td>
<td>Carriers of this gene have cat-like ears.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ears_Pointed</td>
<td>pointed ears</td>
<td>Carriers of this gene have pointed ears.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Nose_Human</td>
<td>human nose</td>
<td>Carriers of this gene have regular human noses.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Nose_Pig</td>
<td>pig nose</td>
<td>Carriers of this gene have pig-like snouts.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Jaw_Baseline</td>
<td>human jaw</td>
<td>Carriers of this gene have regularly-shaped jaws.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Jaw_Heavy</td>
<td>heavy jaw</td>
<td>Carriers of this gene have large jaws.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Head_Gaunt</td>
<td>gaunt head</td>
<td>Carriers of this gene have a pinched, gaunt appearance in their face and head.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Hands_Human</td>
<td>human hands</td>
<td>Carriers of this gene have regular human hands.</td>
<td>0</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Hands_Pig</td>
<td>trotter hands</td>
<td>Carriers of this gene have hands that partially resemble pig trotters. This reduces their ability to manipulate objects.</td>
<td>1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>ElongatedFingers</td>
<td>elongated fingers</td>
<td>Long, delicate fingers improve the carrier's manipulation capacity. This aids with many tasks, especially crafting and construction.</td>
<td>1</td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>Headbone_Human</td>
<td>human headbone</td>
<td>Carriers of this gene have regular human skulls.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Headbone_MiniHorns</td>
<td>mini-horns</td>
<td>Carriers of this gene grow two small horns protruding from the forehead.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Headbone_CenterHorn</td>
<td>center-horn</td>
<td>Carriers of this gene grow a single horn protruding from the center of the forehead.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Voice_Human</td>
<td>human voice</td>
<td>Carriers of this gene have regular human vocal chords.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>VoicePig</td>
<td>pig voice</td>
<td>Carriers have a squealing voice like that of a pig.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>VoiceRoar</td>
<td>roar voice</td>
<td>Carriers have an animal-like roaring voice.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Hemogenic</td>
<td>hemogenic</td>
<td>Carriers of this gene have a reserve of biological strength powered by a resource called hemogen. The resource can be gained and spent in various ways, all of which are unlocked by other genes.\n\nCarriers lose 2 hemogen per day from biological entropy.</td>
<td>1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>HemogenDrain</td>
<td>hemogen drain</td>
<td>Carriers lose an additional 8 hemogen per day from biological entropy.</td>
<td>1</td>
<td>6</td>
<td></td>
</tr>
<tr>
<td>FireWeakness</td>
<td>tinderskin</td>
<td>Carriers have dry, thin skin which burns easily from fire, and their immune systems react very poorly to this kind of threat. Damage from fire is multiplied by 4.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>FireTerror</td>
<td>pyrophobia</td>
<td>Carriers of this gene have an intense fear of fire. When fires are close, there is a chance they will have a mental breakdown at any moment.</td>
<td></td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>PerfectImmunity</td>
<td>perfect immunity</td>
<td>Carriers of this gene have archite-enhanced immune systems which intelligently destroy invaders. They are totally immune to most normal illnesses.</td>
<td>3</td>
<td></td>
<td>1</td>
</tr>
<tr>
<td>DiseaseFree</td>
<td>non-senescent</td>
<td>Carriers of this gene do not go through senescence in the normal way. They never get chronic age-related diseases like cancer, bad back, cataracts, or dementia.</td>
<td>3</td>
<td></td>
<td>1</td>
</tr>
<tr>
<td>TotalHealing</td>
<td>scarless</td>
<td>Carriers of this gene have a special type of regenerator cell which can heal old wounds and chronic illnesses like bad back.</td>
<td>4</td>
<td></td>
<td>1</td>
</tr>
<tr>
<td>Deathrest</td>
<td>deathrest</td>
<td>Carriers of this gene must periodically regenerate themselves in a special coma called deathrest. Deathrest takes days, but can confer substantial bonuses. Deathrest can be accelerated and its effects enhanced by the use of a variety of special buildings and technologies.\n\nThose who put off deathresting will suffer from deathrest exhaustion.</td>
<td></td>
<td>6</td>
<td></td>
</tr>
<tr>
<td>Ageless</td>
<td>ageless</td>
<td>Carriers of this gene have archites in the bloodstream which continuously reverse the process of aging. Starting at the age of 13, carriers begin to biologically age slower. By 18, the aging process stops completely.</td>
<td>3</td>
<td></td>
<td>1</td>
</tr>
<tr>
<td>Deathless</td>
<td>deathless</td>
<td>Carriers of this gene have archites in the blood which will sustain their life processes no matter what. As long as the brain remains intact, a carrier of this gene will never die.</td>
<td>7</td>
<td></td>
<td>1</td>
</tr>
<tr>
<td>ArchiteMetabolism</td>
<td>archite metabolism</td>
<td>Carriers of this gene have special archites in their cells that facilitate and optimize metabolism. This improves overall genetic and metabolic quality.</td>
<td>6</td>
<td>6</td>
<td>2</td>
</tr>
<tr>
<td>WoundHealing_Slow</td>
<td>slow wound healing</td>
<td>Carriers of this gene heal from wounds half as fast as normal.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>WoundHealing_Fast</td>
<td>fast wound healing</td>
<td>Carriers of this gene heal from wounds twice as fast as normal.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>WoundHealing_SuperFast</td>
<td>superfast wound healing</td>
<td>Carriers of this gene heal from wounds four times as fast as normal.</td>
<td></td>
<td>-3</td>
<td></td>
</tr>
<tr>
<td>Immunity_Weak</td>
<td>weak immunity</td>
<td>Carriers of this gene gain immunity to diseases more slowly than normal. They may die from infections that others would survive.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>Immunity_Strong</td>
<td>strong immunity</td>
<td>Carriers of this gene gain immunity to diseases faster than normal.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>Immunity_SuperStrong</td>
<td>super immunity</td>
<td>Carriers of this gene gain immunity to diseases considerably faster than normal.</td>
<td>2</td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>ToxicEnvironmentResistance_Partial</td>
<td>partial antitoxic lungs</td>
<td>Carriers of this gene are resistant to environmental toxins. They get less toxic buildup from tox gas, polluted terrain, and toxic fallout, but are still vulnerable to direct attacks with venom or injected poison. Additionally, they build up rot stink exposure slower.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>ToxicEnvironmentResistance_Total</td>
<td>total antitoxic lungs</td>
<td>Carriers of this gene are immune to environmental toxins, but not from direct toxic attacks. They get no toxic buildup from tox gas, polluted terrain, or toxic fallout, and they are not bothered by acidic smog. They are still vulnerable to direct attacks like venom and injected poison. Additionally, they are immune to rot stink exposure.</td>
<td>2</td>
<td>-3</td>
<td></td>
</tr>
<tr>
<td>Sterile</td>
<td>sterile</td>
<td>Carriers of this gene cannot reproduce by natural means.</td>
<td></td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>Fertile</td>
<td>fertile</td>
<td>Carriers of this gene have a higher chance of becoming pregnant or impregnating others.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Superclotting</td>
<td>superclotting</td>
<td>Carriers of this gene have extra-power coagulating factors in their blood, and will stop bleeding very quickly when wounded.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>KindInstinct</td>
<td>kind instinct</td>
<td>Carriers of this gene are high in trait agreeableness and are very conscientious. They rarely insult others and will sometimes offer kind words to brighten the moods of those around them. They also never judge people by their appearance.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>ViolenceDisabled</td>
<td>violence disabled</td>
<td>Carriers of this gene are emotionally and mentally incapable of engaging in violence. They are overwhelmingly resistant to and horrified by the idea of hurting another.</td>
<td></td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>Nearsighted</td>
<td>nearsighted</td>
<td>Carriers of this gene have difficulty seeing at a distance. Their shooting accuracy at long ranges is reduced.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>StrongStomach</td>
<td>strong stomach</td>
<td>Carriers of this gene have an extra toxin-filtering organ in their stomach and will never suffer from food poisoning even after eating rotten food.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>DarkVision</td>
<td>dark vision</td>
<td>Carriers of this gene see well in low light and are unaffected by mood penalties related to darkness. They have a reflective layer behind the retina that amplifies their ability to see in the dark.</td>
<td></td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>KillThirst</td>
<td>kill thirst</td>
<td>Carriers of this gene lust for the feeling of ending another's life. They will become irritated if they go for too long without killing someone in close combat.</td>
<td></td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>FireResistant</td>
<td>fire resistant</td>
<td>Carriers of this gene have special fast-acting sweat glands and heat-resistant skin. They only take 25% of the normal damage from fire. The chance of them catching on fire is also drastically reduced.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>Inbred</td>
<td>inbred</td>
<td>This genetic condition affects a person's fertility, immunity, and mental capacity.</td>
<td></td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>RobustDigestion</td>
<td>robust digestion</td>
<td>Carriers of this gene grow a multi-fold stomach, allowing them to digest raw foods more efficiently than baseline humans. In general, they get the same nutrition from raw food as from if it is cooked. They also don't mind the taste of raw food at all.</td>
<td>2</td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>Instability_Mild</td>
<td>mild cell instability</td>
<td>Carriers of this gene need less metabolic energy to stay alive, at the cost of reduced stability in their cell-replication machinery.</td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>Instability_Major</td>
<td>major cell instability</td>
<td>Carriers of this gene need much less metabolic energy to stay alive, at the cost of greatly-reduced stability in their cell-replication machinery.</td>
<td></td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>PsychicBonding</td>
<td>psychic bonding</td>
<td>Carriers of this gene have a special neural organ that makes them psychically bond with a lover for life. As long as the lovers are together, they will be happy. If they are physically separated, they will be disturbed by the distance. If one dies, the other's mind will be badly disrupted.</td>
<td>1</td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>PollutionRush</td>
<td>pollution stimulus</td>
<td>Carriers of this gene get a chemical rush from being exposed to pollution. This makes them move faster and helps them think clearer. A similar gene is found in combat-engineered mega-insects.</td>
<td>1</td>
<td>-1</td>
<td></td>
</tr>
<tr>
<td>Unstoppable</td>
<td>unstoppable</td>
<td>Carriers of this gene are not slowed down when taking damage.</td>
<td>1</td>
<td>-2</td>
<td></td>
</tr>
<tr>
<td>NakedSpeed</td>
<td>naked speed</td>
<td>Carriers of this gene move slower while clothed, and faster while naked.</td>
<td>1</td>
<td>2</td>
<td></td>
</tr>
</tbody>
</table></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-06-12T23:13:48+08:00">2023-06-12</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-05"  rel="bookmark" >
              <h2 class="card-title">如何在出远门的时候关闭洗碗机定时启动</h2>
            </a>
            <p class="card-text"><p>家里有个「美的」的某型号洗碗机，一般是积累了当天的碗筷餐具，每天23:00低谷电价之后自动开始定时洗碗。这个功能可以在app上设置实现，还可以设置烘干和通风保存，第二天就能拿出来洁净且干燥的碗筷使用，平时日常这样用起来挺不错。</p>
<p>但是这也导致一个问题，如果节假日出门旅行几天，这个洗碗机里即便没有碗筷，也会傻傻的启动浪费水电，所以需要禁用几天，我的操作流程是：</p>
<ol>
<li>掏出手机，解锁屏幕，找到「美的美居」 app并打开</li>
<li>欣赏该厂家运营设置的精美开屏广告并等待</li>
<li>打开「场景」</li>
<li>找到自动化 - 已开启 列表里，关于洗碗机的部分</li>
<li>找到进入每天自动洗碗的选项，编辑，选择关闭</li>
<li>保存设置，退出 app</li>
<li>回到家，又需要按照上面的流程操作一番启用该流程</li>
</ol>
<p>每次想起这个事，真是又繁琐又蛋痛。特别是回来如果忘记启用，第二天早上起来会发现一篮子未洗的碗筷傻眼。</p>
<p>这次五·一假，我压根忘记了禁用定时洗碗的事。但是回到家添加洗碗粉的时候发现，这几天洗碗机并未启动。问了下是我老婆操作的，她的流程是：</p>
<ol>
<li>给洗碗机门板开一条缝</li>
</ol>
<p>洗碗机不会在门没关严的情况下启动，所以。。。。</p>
<p>我问她这样做是故意的还是不小心的，她说故意不小心的。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-05-13T06:11:28+08:00">2023-05-13</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-04"  rel="bookmark" >
              <h2 class="card-title">当前版本gpt的根本弱点</h2>
            </a>
            <p class="card-text"><p>下面的东西仅限当前，不是不可以解决的。</p>
<ol>
<li>gpt系列数学能力不行，是因为它把每一个数字当成一个整体在背加法表、乘法表。没理解到十进制的精髓</li>
</ol>
<p><img alt="" src="/images/2023/stdout-04-01.webp" /></p>
<p>上图来自<a href="https://arxiv.org/abs/2005.14165">2020年 GPT-3 论文</a> 22页。主要还是因为 BPE 太糙。 </p>
<ol start="2">
<li>
<p>gpt-4能通过一些文字材料和描述感知到每个字母大概长什么样，甚至知道一些简单汉字的结构，但是确切的书写结构它是不知道的。<br />
所以要避免你的想法被 gpt 感知学会，得考虑每个字的偏旁部首作文章，而且你的变形得很少见。估计这个技巧在将来被AI监视的生活里会被用得上。</p>
</li>
<li>
<p>还有一些语音漂移它知道概念但是因为没发音器官所以不能直接感知。但这也不是不能解决，只要语料够大也能摸到规律。相比英语等拼音文字而言，汉字这类表意但是又有同音的文字应该是文本类 AI 的普遍弱点。</p>
</li>
</ol>
<p>如果你要秘密表达一些观点，可以通过描述发音、形状或者动作但是不直接写出来让对方领会。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-03-31T15:07:02+08:00">2023-03-31</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stderr-08"  rel="bookmark" >
              <h2 class="card-title">Google 和 Facebook 为什么不行了</h2>
            </a>
            <p class="card-text"><p>Google 最先搞出来 word2vec，最先搞出来transformer 和 BERT，最先搞出来被员工发现 sentient 的 LaMDA，被 ChatGPT 骑脸之后匆忙推出个半成品 Bard </p>
<p>这一切为啥呢？我觉得很可能是 <a href="https://www.google.com/search/howsearchworks/our-approach/">Google的愿景</a>：</p>
<blockquote>
<p>Google's mission is to organize the world's information and make it universally accessible and useful.</p>
</blockquote>
<p>全世界的信息，可以说已经被 Google 成功的「组织」起来了。只不过很可惜，它并没有想要全部「理解」和「消化吸收」，把信息变成「通识」。ChatGPT 正在尝试做到这一点。</p>
<p><a href="https://www.microsoft.com/en-us/about">微软的愿景</a>是什么呢？ </p>
<ul>
<li>"Be what's next." (2010-2012)</li>
<li>"Empowering us all"</li>
</ul>
<p>所以它很快收购了 Skype 推出 Teams，收购 Github 然后投资 OpenAI，结合 Codex (code-davinci-002) 推出 Github Copilot，然后顺理成章搞出来 Office 系列的 Copilot。工具性拉满。</p>
<p>然后说下为啥 Facebook 要 All in metaverse。这个在 <a href="https://www.scribd.com/document/399594551/2015-06-22-MARK-S-VISION">2015-06-22 有个 leaked memo</a> 说得很清楚</p>
<blockquote>
<p>Our vision is that VR / AR will be the next major computing platform after mobile in about 10 years. It can be even more ubiquitous than mobile – especially once we reach AR – since you can always have it on. It’s more natural than mobile since it uses our normal human visual and gestural systems. It can even be more economical, because once you have a good VR / AR system, you no longer need to buy phones or TV’s or many other physical objects – they can just become apps in a digital store. ... We are vulnerable on mobile to Google and Apple because they make major mobile platforms. We would like a stronger strategic position... We can achieve this only by building both a major platform as well as key apps.<br />
我们的愿景是，在大约十年后，VR / AR将成为继移动设备之后的下一个主要计算平台。它甚至可以比移动设备更普及 - 特别是一旦我们达到AR - 因为您可以随时随地使用它。它比移动设备更自然，因为它使用我们正常的人类视觉和手势系统。它甚至可以更经济，因为一旦您拥有了一个好的VR / AR系统，您就不再需要购买手机、电视或许多其他物理物品 - 它们只能成为数字商店中的应用程序。我们在移动设备上对谷歌和苹果公司非常脆弱，因为它们制作了主要的移动平台。我们希望拥有更强大的战略地位... 我们只有通过建立一个主要平台和关键应用程序才能实现这一点。</p>
</blockquote>
<p>问题是，VR/AR 并不是手机的下一代。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-03-28T21:49:11+08:00">2023-03-28</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-03"  rel="bookmark" >
              <h2 class="card-title">Play Cities:Skylines on Windows/MacOS without Paradox Launcher</h2>
            </a>
            <p class="card-text"><p>Haven't played Cities: Skylines for ages, so I re-installed it on Steam, after some updates there's this new Paradox Launcher which serves no purpose but wasting time. So I decided to remove it, googled some <a href="https://steamcommunity.com/sharedfiles/filedetails/?id=1976349559">guide</a> and unfortunately it contains too many steps and some error occured while following it. Here's the simpler &amp; correct step of what I did instead.</p>
<p>After the game is downloaded, open the Steam library, find the game, right click, choose <code>Properties...</code></p>
<p><img alt="" src="/images/2023/stdout-03-01.webp" /></p>
<p>Next for the <code>Launch Options</code>, type</p>
<h3>on Windows</h3>
<pre><code>cmd /c start cities.exe %command%
</code></pre>
<h3>on MacOS</h3>
<pre><code>/Users/$USER/Library/Application\ Support/Steam/steamapps/common/Cities_Skylines/Cities.app/Contents/MacOS/Cities %command%
</code></pre>
<p>Make sure you replace <code>$USER</code> with your username</p>
<p>Then the game works like good o' times, straight to the menu.</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-01-30T22:13:49+08:00">2023-01-30</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stderr-02"  rel="bookmark" >
              <h2 class="card-title">《阿凡达2:水之道》是一部辱日片啊</h2>
            </a>
            <p class="card-text"><p>昨天刚看完，整体感觉画面还是美轮美奂的。我没看出来有什么故弄玄虚的情节，也没觉得网上说那些故事性不行到底不行在哪里。不过有很多场面感觉不是怎么适合带娃去看，好多暴力、流血、残忍包括几十秒展示捏碎一个真正的骷髅等镜头。</p>
<p>在其中一个 Tulkun Hunting 大场面，一开始还对为啥找个东亚面孔扮演反派感到奇怪</p>
<p><img alt="avatar2 whaling crew" src="/images/2023/stderr-02-01.webp" /></p>
<p>然后就出现了好几秒的「日捕」爆炸捕鲸叉的特写。这是把「日本捕鯨協会」写脑门上了啊。。。</p>
<p><img alt="日捕" src="/images/2023/stderr-02-02.webp" /></p>
<p>截图来自tiktok不是很清晰。但是这妥妥辱日了吧。。。说阿凡达2不好看的，是不是拿了日本外务省的钱？233333 </p>
<p>看完网上搜了下<a href="https://np.reddit.com/r/japanese/comments/zov9by/k">讨论</a>，有人说这是 日浦 Hiura 的名字，但是这又不是一个常见的日本姓名 ，所以我觉得 James Cameron 这故意用个错别字避免刚正面。</p>
<p>现实中的<a href="https://phys.org/news/2015-05-japan-whaling-science-microscope.html">日本捕鲸叉</a>长这样</p>
<p><img alt="japanese whale harpoon" src="https://scx1.b-cdn.net/csz/news/800a/2015/crewofawhali.jpg" /> </p>
<p>十分写实了。而且捕鲸一开始也是为了鱼油，而且日本捕鲸也是冒充科研用途，和电影里的情节不能说雷同只能说。。。一模一样？</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-01-21T11:28:37+08:00">2023-01-21</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2023/stdout-02"  rel="bookmark" >
              <h2 class="card-title">文字的毒害</h2>
            </a>
            <p class="card-text"><p>看到个号称不支持 css/js/wasm 和图片的<a href="https://news.ycombinator.com/item?id=34350436">浏览器 Kristall</a>，觉得这玩意太蠢了。这让我<br />
想起柏拉图的 <em>Phaedrus</em> 里讲了<a href="https://www.dedao.cn/share/course/article?id=vWbYRP1mxqd2VGdd9ZJQjM096EBkr8">苏格拉底的一个段子</a>，苏格拉底作为欧亚大陆的头号智慧导师，博学多才，却没留下传世著作。因为但是他老人家本身是反对文字和书写的，有这么几个原因：</p>
<p>第一条，文字伤害记忆和智慧。Letter is an aid not to memory, but to reminiscence, and you give your disciples not truth, but only the semblance of truth</p>
<p>首先值得注意的是，这里很有可能指的是拼音文字里的「字母」 而不是古埃及神 Theuth 创作的象形文字。我认为发音字母构成的书写体系肯定是对记忆有害的，文字上的词性和变位更是对视力和理解力的低效率的折磨。快速理解都会强调 Subvocalization 的重要性。汉字作为一个 ideogram 真是一个神发明。总体来说，这条道理是对的。文字只是记忆的粗略模拟和辅助，是真理的外表轮廓。</p>
<p>知识其实这玩意可以被大致分为两类：propositional knowledge 和 know-how。命题和过程知识。</p>
<p>什么是命题？比如「一只青蛙四条腿」就是典型的命题。人们可以根据生活经验获得大量命题；</p>
<p>过程知识就比较微妙了。人们可以通过文字获得过程知识，比如你可以通过学习五线谱了解乐谱如何和发音一一对应，观看钢琴视频得知乐器如何演奏，但是让你实际上手呢？依然不会。</p>
<p>文字就容易造成一个错觉，把结论和过程的「描述」记住了，不等于你获得了真实的知识。有的时候甚至你记下来的就是个结论，连它内在逻辑都无法知晓。孔老夫子就说过「学而不思则罔，思而不学则殆」。文字是有欺骗性的。很多时候你写下来了背下来了以为就记住了。实际上你只记住了一个表皮。</p>
<p>第二条，文字是固化的，死气沉沉的，不如口头语言丰富有活力，不如口传心授有感染力。这个理由，也有局限性。因为文字表达能力在苏格拉底的时候不行，但是这玩意可以进化的。几千年演化下来，文字的表达能力一点也不差。</p>
<p>第三条，文字使语言失控。苏格拉底的原话是这么说的：“一件事一旦被写下来，不论什么内容，到处都会流传的，既会传到能看懂的人的手里，同样也会传到无关的人手里。文字本身并不知道如何与正直的人说话，也不知道如何不与邪恶的人说话。因为文字没有自卫或自救的能力。” 这个道理其实非常值得深思。</p>
<p>书写不是真理的后代，而是真理的私生子。人们歪曲理解文字，就如同私生子受到欺负没有亲生父母帮忙一样。苏格拉底还说，智慧的语言是用来雕刻学习者的心智的。需要知道什么说什么话，什么时候闭嘴。知识是活的，有多面性，需要对听众定制诉说，而不是像一副绘画那样只从一个角度说明问题。理智的人说话就像在花园里埋下一颗种子，听者心里才会开花结果。而不是一味挖洞翻土。</p>
<p>道理讲了这么多，其实对我的启发就是传播思想。喊死板口号是绝对没有用的。必须得定制化、个性化传播。如同现在推荐系统一样，做到千人千面。真正厉害的营销和洗脑不是「羊羊羊」那样反复重复洗脑，而是静心巧妙的植入。</p>
<p>想到这里，我觉得，以前 PC 时代发布视频，是由少数精英团队的制作，通过 Flash/MPEG这种录制成视听作品或者节目，扩散式的单向散开传播；3G 4G 带来的高带宽普及，智能机带来的H.264专用处理芯片的普及，让人人拍视频成为了可能，让全球迎来了一个视频传播思想的时代。大家看不起的营销号洗稿行为，在我看来是一个极其合理必然。知识的传播，本来就应该自然发生变异，我们只是缺乏一个有效的优胜劣汰的定向过滤器。把一件事前因后果用文字写清楚的人不多，但是文盲都可以拿起手机录制一段讲话。所以在人人都能发视频的时代，打破了文字的垄断，带来大量的土味和「俗」味视频。因为媒介的改变，不仅是从文字到图片、视频的升级那么简单，而是人和人对话、交流、碰撞的一次彻底颠覆；以前的大道理、小道理是基于文字的浓缩，抽象成一个又一个的符号，比如国家，比如民族，比如儒家、清教徒这种门派。现在抛弃抽象，回归到具象。在文字的时代，搜索引擎为王。因为这种技术有一定门槛，而且当时互联网上全是「超文本」的海洋。高校的理论知识是网页，门户的新闻是大段文字，个体用户参与的 BBS 讨论也是文字。现在不一样了，学术报告是扫描版pdf，门户都是app里的walled-gargen，群众的议论全是长截图。文字沦为配角，作为字幕存在于某一帧配图的下方，或者是一个箭头指向的注解。最具冲击力的，往往是影像，比如唐山打人的监控 footage，再比如导致 BLM 的那张 Floyd 跪脖子的图片。</p>
<p><a href="https://m.bjnews.com.cn/detail/163534466414888.html">社会现代化意味着</a>传统、稳定的社区纽带被打散，现代人的生活成为一场漫长的“流浪”，人们不断被抛入陌生的地点、陌生的群体、陌生的关系，“独自承受”一切挑战。这种原子化状态驱动着弗洛姆所说的“逃避自由”心理——人们试图在不断分崩离析的世界中抓住一点什么，哪怕抓住的仅仅是“想象的共同体”。</p>
<p>从这一点上来说，我们回到了千百年前那个知识以口口相传的时代。面对这样的历史巨变，我个人的见解是：</p>
<ol>
<li>口头交流比任何一个时代都更加重要。中小学应该压缩文字书写的时间，改为制作 ppt 宣讲技能培训和口头辩论。</li>
<li>应该把音韵、对联、单押、双押、rap、music、的重要性提高。现在自媒体 BGM 水平太低，而且说服力和韵脚好坏成正比。</li>
<li>ChatGPT 是一把双刃剑，既可以在一段文字里无缝植入商品广告，也可以解决苏格拉底反对 letters 提出的文字的种种缺点，把文字变成个性化、启发式学习一个利器。</li>
<li>下一代说服力工具，应该是类似 ChatGPT 但是作为虚拟形象对现实生活的再加工和演绎。技术侧需要有对图片和视频「表达的思想」的理解能力。</li>
</ol></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2023-01-12T23:12:03+08:00">2023-01-12</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-13"  rel="bookmark" >
              <h2 class="card-title">Jira里JQL实现查找上一个「工作日」的任务</h2>
            </a>
            <p class="card-text"><p>厂里终于开始用笨拙的Jira了。总体用下来跟 Teambition 相比各有各的笨处。。。</p>
<p>默认的 board 过滤器有点不好用。本着为了stand-up meeting和周报快速检索上一个工作日和当周干了什么，找到一个 filter 写法：</p>
<h3>JQL过滤上一个工作日干了啥：</h3>
<pre><code>(updatedDate &lt; endofweek("-8d") AND updatedDate &gt; startofday("-3d")) OR updatedDate &gt; startofday("-1d")
</code></pre>
<p>这里不是简单的查昨天干了啥。比如周一需要看周五干了啥。所以有个 <code>-8d</code> 并 <code>-3d</code> 的神奇操作。具体的逻辑自己琢磨</p>
<h3>过滤本周干了啥</h3>
<pre><code>updatedDate &gt;= startOfWeek(0)
</code></pre>
<p>Jira这种资本主义软件是没法适配我们社会主义法定节假日的设定。所以遇到非双休放假还是判断起来比较蛋痛。</p>
<p>其实我比较反感每天早上开站会。我比较推荐每天下班前最后10分钟开会。好处有：</p>
<ol>
<li>当天干了什么记得很清楚。明天需要干什么也很显然。</li>
<li>如果谁拖堂，谁就承担对不起大家不能准时下班的道德压力</li>
<li>如果都开会了你事情都还没做完，要么你事情安排得太多，要么你完成能力不足，要么你时间安排有问题。</li>
</ol>
<p>之前在两个公司这样执行过。结果被大老板强行改到早上开会了。无语。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-12-12T14:51:50+08:00">2022-12-12</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-12"  rel="bookmark" >
              <h2 class="card-title">Web Animation实现页面逐渐变灰</h2>
            </a>
            <p class="card-text"><p>在2006年我开始网上留下印记的时候，写了一个 dHTML 特效模拟<a href="https://blog.est.im/cnblogs/600413">XP关机对话框变灰</a>， 那个时候大行其道的还是IE6，用的还是微软特有的 <code>filter:progid:DXImageTransform.Microsoft.Fade</code> 叠加两个<code>&lt;div&gt;</code>实现。</p>
<p>今天（2022-11-30）恰好长者去逝，学习一下最新的css姿势再实现一次。本来想用 CSS Animation+Filter实现，还是比较麻烦。比如我参考的例子是<a href="https://levelup.gitconnected.com/recreating-the-red-dead-redemption-2-tintype-loading-screen-effect-in-css-10ca87d5b9de">模仿 Red Dead Redemption 2</a> 照片效果css</p>
<pre><code>  #invert{
    filter: invert(1.0) grayscale(1.0);
  }
  #photo{
    animation: blur 5s infinite alternate;
  }
  @keyframes blur{
    from{
      filter: blur(3px);
      opacity: 0;
    }
    to{
      filter: blur(0px);
      opacity: 1;
    }
  }
</code></pre>
<p>这个方式有个问题就是需要单独设置一个 <code>&lt;script&gt;</code> 元素。后来经过 <a href="https://twitter.com/yuanchuan23">@yuanchuan23</a> 的指点发现可以通过 Web Animation 更简单的实现：</p>
<pre><code>  document.body.animate([
    {filter: 'brightness(none) grayscale(0%)'},
    {filter: 'brightness(10) grayscale(10%)', offset: 0.2},
    {filter: 'brightness(1) grayscale(100%)'}
  ], {duration: 2000, fill: 'forwards'})
</code></pre>
<p>这样写比 css 方便多了。加一个类似照相机闪光灯过曝的效果。其中 <code>fill: 'forwards'</code> 可以让变灰之后停下来。</p>
<p>放一个 demo 在这里：<a href="https://lab.est.im/grayscale_animation">https://lab.est.im/grayscale_animation</a> 点一下可以再变一次</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-11-30T18:02:18+08:00">2022-11-30</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-11"  rel="bookmark" >
              <h2 class="card-title">8行javascript录制屏幕</h2>
            </a>
            <p class="card-text"><p>看到个骚操作，玩了一下，写了个 bookmarklet</p>
<pre><code class="language-javascript">navigator.mediaDevices.getDisplayMedia({video:true}).then(function(stream){
  const mr=new MediaRecorder(stream,{mimeType:&quot;video/webm;codecs=h264,opus&quot;});
  mr.ondataavailable=function(ev){
    const a=document.createElement('a');a.href=URL.createObjectURL(ev.data);
    a.download ='screen_capture.webm';a.click();
  }; // will be called when .stop() with ev.data as a Blob
  mr.start();
})
</code></pre>
<p>这段代码也是很多WebRTC共享白板的实现原理。看起来也很简单，而且不需要额外的权限确认。</p>
<p>如果不需要另存为一个名字，则可以直接 <code>location.assign()</code> 又节约几个字。不知道还有没有办法继续节约代码量？</p>
<p>有点很好奇为啥chrome不支持 .mp4 封装。偏袒自家的 webm ？</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-11-18T18:50:05+08:00">2022-11-18</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-10"  rel="bookmark" >
              <h2 class="card-title">JS播放 DTMF</h2>
            </a>
            <p class="card-text"><p>玩 WebRTC 的时候发现它居然内置<a href="https://hacks.mozilla.org/2015/11/webrtc-sending-dtmf-in-firefox/">支持了 DTMF 拨号音</a>。</p>
<p>这里就简单科普一下，DTMF 就是手机电话拨号音，数字按键按下去嘟嘟嘟响那个。具体就2个频率调谐：</p>
<table>
<thead>
<tr>
<th>DTMF</th>
<th>1209Hz</th>
<th>1336Hz</th>
<th>1477Hz</th>
<th>1633Hz</th>
</tr>
</thead>
<tbody>
<tr>
<td>697Hz</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>A</td>
</tr>
<tr>
<td>770Hz</td>
<td>4</td>
<td>5</td>
<td>6</td>
<td>B</td>
</tr>
<tr>
<td>852Hz</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>C</td>
</tr>
<tr>
<td>941Hz</td>
<td>*</td>
<td>0</td>
<td>#</td>
<td>D</td>
</tr>
</tbody>
</table>
<p>于是兴趣来了想做一个 demo 玩玩，写了半天调试不通，报错</p>
<blockquote>
<p>VM987:1 Uncaught DOMException: Failed to execute 'insertDTMF' on 'RTCDTMFSender': The 'canInsertDTMF' attribute is false: this sender cannot send DTMF.</p>
</blockquote>
<p>仔细研究了下<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Using_DTMF">这玩意</a>，原来 WebRTC 不直接传音频，而是发一个控制信号，由接收方播放出音频，所以你需要本地创建一个真实的双工 RTC 并打开麦克风权限，才能播放DTMF音频。</p>
<blockquote>
<p>WebRTC doesn't send DTMF codes as audio data. Instead, they're sent out-of-band, as RTP payloads. Note, however, that although it's possible to send DTMF using WebRTC, there is currently no way to detect or receive incoming DTMF. WebRTC currently ignores these payloads;</p>
</blockquote>
<p>这样就走远了。于是又手痒用 <code>AudioContext()</code> 糊了一个。一共不到1000字节。</p>
<p><a href="https://lab.est.im/dtmf">https://lab.est.im/dtmf</a> <a href="https://github.com/est/snippets/blob/master/dtmf/index.html">源码</a></p>
<p>嗯。就挺简单的。特别是那个 oscillator有个 <code>.stop(0.2)</code> 参数可以避免 <code>setTimeout</code> 的麻烦。网上很多教程整复杂了。</p>
<p>btw 把一些老脚本挂在 lab 域名下。<br />
btw2 把 RSS 改成全文输出了。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-10-30T19:20:49+08:00">2022-10-30</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-09"  rel="bookmark" >
              <h2 class="card-title">Cloudflare worker 返回浏览器ip:端口</h2>
            </a>
            <p class="card-text"><p>看到个贴 <a href="https://www.v2ex.com/t/885568">返回客户端连接用的 IP 和端口号</a>，想起来也需要熟悉一下 Cloudflare worker，于是拿来练练手</p>
<pre><code>  export default {
    async fetch(request, env) {
      return await handleRequest(request).catch(
        (err) =&gt; new Response(err.stack, { status: 500 })
      )
    }
  }

  async function handleRequest(request) {
    const { pathname } = new URL(request.url);

    if (pathname === "/ip") {
      const ip = request.headers.get('CF-Connecting-IP');
      return new Response(ip + '\n');
    }

    if (pathname === "/ip:port") {
      const ip = request.headers.get('CF-Connecting-IP');
      const port = request.headers.get('est-Connecting-Port') || '?'
      return new Response(ip + ':' + port + '\n');
    }

    return new Response('Tools:\n /ip\n/ip:port\n');
  }
</code></pre>
<p>遇到一个问题，Cloudflare 官方有提供浏览器客户端IP变量 <a href="https://developers.cloudflare.com/workers/runtime-apis/headers/#cloudflare-headers"><code>CF-Connecting-IP</code></a> 但是缺少端口，查了下可以自己通过 <a href="https://developers.cloudflare.com/rules/transform/request-header-modification/reference/fields-functions"><code>cf.edge.client_port</code></a> 这个变量获得， <a href="https://community.cloudflare.com/t/need-cf-connecting-port-for-french-law/319505/8">方法</a>是在进入 CF网站管理 面板 → Rules → Transform Rules → HTTP Request Header Modification 里添加一条请求头规则。如图：</p>
<p><img alt="" src="https://global.discourse-cdn.com/cloudflare/original/3X/b/a/ba21c8b28a8915bc57c6c6d82581827578e232ac.png" /></p>
<p>但是 header 不能以  <code>CF-</code> 开头，所以这里改成 <code>est-Connecting-Port</code>，就能获得客户端请求的 IP+端口 了</p>
<p>测试地址： t.本网站根域名/ip:port</p>
<p>目前还缺：IPv6 的正确表示。。。。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-10-09T23:12:02+08:00">2022-10-09</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-08"  rel="bookmark" >
              <h2 class="card-title">macOS动态定时弹提醒</h2>
            </a>
            <p class="card-text"><p>上班地方有个付费计时，想在倒计时结束前在电脑弹个提醒，手动结束计费，趴下来API了。接下来就是如何弹窗了。</p>
<p>本来想用macOS自带的 <code>UNUserNotificationCenter</code> 通过 PyObjC 撸个弹窗，遇到两个问题：</p>
<ol>
<li>系统自带的 PyObjC 太老了。还是Python2.7的。在<code>/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python/PyObjC</code></li>
<li>只能兼容旧款的 <code>NSUserNotification</code>，状态为 macOS 10.8–11.0 Deprecated<br />
 新的API调用需要进程签名。<br />
<code>codesign -dv --verbose=4 /usr/bin/python2.7</code></li>
</ol>
<p>只有官方的python2.7签名了 anaconda/miniconda 的都没签名。算了。还是直接 AppleScript 走起</p>
<pre><code>  osascript  -e 'display notification "还有1分钟到达时辰" with title "准时付费" sound name "Frog"'
</code></pre>
<p>想在这个提示里加一个 snooze 1分钟功能，但是好像无法支持。罢了。2333</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-07-20T14:52:56+08:00">2022-07-20</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-07"  rel="bookmark" >
              <h2 class="card-title">终于吧 blog 的自动构建 pipeline 配置好了</h2>
            </a>
            <p class="card-text"><p>目前博客是基于 pelican 的 static-site generator，一个 python 模块本地渲染成静态文件然后通过 github pages 发布。</p>
<p>源码放在 bitbucket，之前比较懒都是本地跑，一直想改成 CI/CD pipeline，今天终于配置好了。记录一些坑吧</p>
<ol>
<li>bitbucket pipeline 不同 step 之间数据是不共享的。本来想用 parallel 功能在下载 pip 模块和 git clone 皮肤做个并行，后来发现 artifact 拷贝速度还不如串行去跑。就所有操作一个 step 做完</li>
<li>
<p>博客源码和生成结果可以直接同步提交信息：    </p>
<pre><code>msg=$(git log -1  --pretty=%B)
cd output
git config user.name est
git config user.email 邮箱
git add .
git commit -m "$msg"
git push
</code></pre>
<ol start="3">
<li>
<p>由于 pip 模块装了不知道在哪里，所以调试 pip 安装路径方法：    </p>
<p><code>python -c 'import site; print(*site.getsitepackages(), sep="\n")'</code></p>
</li>
</ol>
</li>
<li>
<p>pelican 默认居然没支持 Markdown 也是醉了    </p>
<pre><code>python -m pip install pelican==4.8.0 Markdown
</code></pre>
<ol start="5">
<li>
<p>自定义皮肤依赖，由于 submodule 我没玩转，所以这样安装：    </p>
<p>git clone --depth=1 git@github.com:est/aether-pelican.git || (cd aether-pelican; git pull --rebase)</p>
</li>
</ol>
</li>
</ol>
<p>Bitbucket 每个月有50分钟的免费pipeline 时间，自己用下来差不多29秒 build &amp; publish 一次。感觉每个月也写不了60篇，所以目前是够了。</p>
<p>接下来的优化：</p>
<ol>
<li>新图片通过 squoosh 压缩优化</li>
<li>通过 cloudflare worker 替换掉 disqus 评论功能</li>
</ol></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-07-19T19:06:49+08:00">2022-07-19</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-06"  rel="bookmark" >
              <h2 class="card-title">袁亚湘院士数学不错，但是历史不行</h2>
            </a>
            <p class="card-text"><p>网上看到一个院士的段子 <a href="https://m.weibo.cn/detail/4764029988111490">1</a> <a href="https://m.weibo.cn/detail/4763768209540706">2</a></p>
<p>搜了下，2020年3月14日，在中国工业与应用数学学会举办的网络科普活动中，中国科学院院士袁亚湘带来题为“数学漫谈”的主题报告</p>
<p><a href="https://mp.weixin.qq.com/s/JllGeuveomjFDFg3C5r9FQ">https://mp.weixin.qq.com/s/JllGeuveomjFDFg3C5r9FQ</a></p>
<blockquote>
<p>关于π有很多神奇的故事。因为时间关系，我今天就讲其中的一个。不知道在座的观众有没有看过一个美剧叫做《疑犯追踪》。在第2季11集中，Harold Finch说过在π里面能够找到任意数列。当然这个东西数学家并没有证明，但是很多数学家认为可能是真的。<br />
我试了试，我挑了我们建党的日子19210701，出现在π的第44,842,733位。如果输入去中华人民共和国成立之日，也就是19491001的话，就要往后很多，要到82,267,377位。开个玩笑，π都说明了要先有共产党才有新中国。<br />
一个网友要求我要查一下1314，大家看到1314到3902位就找到了。所以各位观众，1314（一生一世）不是那么难啊。但是如果1314前面加个520（我爱你）的话，那就难多了。如果你要找5201314，那就要查到200多万位。所以同学们一定要记住啊，实际上爱情还是很艰难的。</p>
</blockquote>
<p>这段话数学上来说是没问题的，但是院士可能没注意历史，建党的真正时间是一大正式召开的时间，<a href="http://www.xinhuanet.com/politics/2020-06/23/c_1126148992.htm">1921年的7月23日</a></p>
<p>那么我们把两个时间再去看一下在 Pi 里的位置：</p>
<p><a href="https://www.angio.net/pi/">https://www.angio.net/pi/</a></p>
<pre><code>  The string 19491001 occurs at position 82267377
  The string 19210723 occurs at position 101114100
</code></pre>
<p>所以这说明了啥？</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-05-06T12:03:50+08:00">2022-05-06</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-05"  rel="bookmark" >
              <h2 class="card-title">Add UTF-8 BOM header to Flask-Admin export</h2>
            </a>
            <p class="card-text"><p>A simple trick to add additional bytes prepending Flask's <code>stream_with_context</code></p>
<pre><code>  from flask_admin.contrib.sqla import ModelView
  from itertools import chain

  class MyAdminView(ModelView):
      can_export = True
      column_export_list = ['field1', 'field2']

      def _export_csv(self, return_url):
          r = super(MyAdminView, self)._export_csv(return_url)
          r.response = chain((b'\xef\xbb\xbf',), r.response)
          return r
</code></pre>
<p>I am still using Python2 and Flask-admin shit. It's a shame but anyway.</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-04-14T15:47:17+08:00">2022-04-14</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-04"  rel="bookmark" >
              <h2 class="card-title">牛津树/Good English/典范英语里的宗教私货</h2>
            </a>
            <p class="card-text"><p>牛津树 Oxford Reading Tree 是被国内咪蒙妈妈们吹得油爆爆的来自英国的少儿学习体系，Good English/典范英语 是中青出版社的部分摘录英语教材。</p>
<p><img alt="" src="/images/2022/stdout-04-01.jpg" /></p>
<p>偶然发现这个 <a href="https://m.sohu.com/a/417948407_120594135/">牛津树【4-29】Mosque School</a>，讲了一个叫 Adam 的学龄前儿童机缘巧合进了经文学校的短故事。甚至如果这是从古兰经某个传教段子改编出来的我一点都不惊讶。</p>
<p>引起我注意的是小白帽的装束，以及牌子那几个字 Masjid-E-Noorul Islam </p>
<p>费了点心思搜了下，也拼为 <a href="https://en.wikipedia.org/wiki/Nurul_Islam"><em>Nurul Islam</em></a> 或 <em>Nur ul-Islam</em>，意思是 <em>light of Islam 伊斯兰之光</em>。</p>
<p>国内很多中专职高出来的英语老师可能没理解这里面的内涵。什么叫潜移默化植入意识形态啊？！当人们觉得这是文化「多样性」很正常？！以为清真学校就是普通的讲宗教的学校，其实经文学校传授的东西非常不简单。摘抄一些百科：</p>
<blockquote>
<p>经文学校分为“地尼买克塔普”、“买德里斯”、“卡里哈纳”三种。<br />
经文小学是中国伊斯兰教经堂教育建制之一。俗称“经学”。专为年满6～7岁的穆斯林儿童所设，多在清真寺内，少数系私人开办，在教师或师娘的住宅内。设在清真寺内的经文小学，教师皆由该寺教职人员担任。课程由认识、诵读、书写阿拉伯字母开始。待学会拼音之后便相继以《索尔夫》、《穆阿济》、《扎佳尼》、《阿瓦米勒》与《米苏巴哈》为教科书(俗称“连五本”)。进而开讲《亥听》(即《古兰经》选读本)、《古兰经》。经文小学的学童至10岁左右，率多辍学从事家庭生产劳动或参加社会职业，只有少数人转入经文大学，继续接受高一级的伊斯兰教经堂教育，被称为“满拉”或“海里凡”。经文小学没有严格的学籍管理，招生不定期，也不经过考试，辍学或退学甚为自由，没有班级排列。学童的进度不齐，故普遍采取复式教学法。另有伊斯兰教常识课程，每日放学前集体朗诵(系中国阿訇自编启蒙教材，俗称“杂学”)。“杂学”的内容包括沐浴、礼拜、斋戒、丧葬及游坟等宗教活动应念的都阿、苏赖。1911年辛亥革命成功后，一些设于清真寺内的经文小学开始聘请懂汉文的穆斯林给学童加授汉文启蒙性教科书。女童上经文小学率多在师娘私宅。学费没有定制，学童家长可量力向师傅(师娘)不定期地馈送海迪耶。</p>
</blockquote>
<p>官方介绍可以参考 <a href="https://cati.nwupl.edu.cn/dtzx/hswx/10307.htm">https://cati.nwupl.edu.cn/dtzx/hswx/10307.htm</a> 中 「保守教派的兴起」 这一部分，维基百科 <a href="https://zh.wikipedia.org/zh-cn/%E6%89%8E%E5%90%89%E5%BE%B7">扎吉德 Jadid</a>，<a href="https://liyongfeng.blog.caixin.com/archives/81444">民间经文学校初步观察</a></p>
<p>如果你觉得这样的东西堂而皇之放在英语教材里没啥问题。。。我也没啥好说的。。。</p>
<p>其中这一段比较有趣：</p>
<blockquote>
<p>情况与当时还属于苏联的中亚五国是一致的。这个过程中，瓦哈比派（Wahhabism）因为主张“回到《古兰经》中去”，注重个人对经典的领悟而非学者的解释，门槛很低，容易接受</p>
</blockquote>
<p>这不王阳明心学么。。。。释经权的下放和离散化。。。这后果。。啧啧。。。。参考之前一篇《<a href="/2021/stdin-009#p20">中世纪中国的宗教改革</a>》</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-02-16T00:05:16+08:00">2022-02-16</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-03"  rel="bookmark" >
              <h2 class="card-title">徐州丰县，以及孝文化</h2>
            </a>
            <p class="card-text"><p>先<a href="https://www.bilibili.com/read/cv10613832">抬一张地图</a>出来，</p>
<p><img alt="" src="/images/2022/stdout-03-01.webp" /></p>
<p>鲁苏豫皖四省，如果让你选一个最乱的地，你可能选哪里呢？</p>
<p>说起来，徐州对我的印象，只是《三国演义》上一个模糊的地理概念，第一次稍微立体的感受徐州，还是在《<a href="https://www.bilibili.com/video/BV1uE411C7gj">睡前消息29 · 没有“淮海省”，徐州还是有当“省会”的命？</a>》上看到，徐州是一个距离周边大城市都非常远的人口又比较密集的城市。</p>
<p><img alt="" src="/images/2022/stdout-03-02.jpg" /></p>
<p>后来，从<a href="https://www.dedao.cn/share/course/article?id=92GB1my8okM5VMnZylJWgNnEe4Z73r">罗辑思维·启发俱乐部·第26期：显性力量越大，隐性麻烦越多</a>》上扒到徐州周边刷过的历史人物，就更印象深刻了</p>
<p><img alt="" src="/images/2022/stdout-03-03.jpg" /></p>
<blockquote>
<p>这里是砀山，刘邦拔剑斩蛇起义的地方，它属于安徽省，但它同时被另外三个省包围，北部是山东，东部是江苏，西部是河南。<br />
从这个地方向东北，开车不到一个小时，就能到达江苏省的丰县。刘邦就是丰县人。辅佐刘邦建立汉朝的很多人，像萧何、卢绾、王陵也是丰县人。<br />
丰县的东边是沛县，刘邦集团的樊哙、曹参、周勃都是沛县人。你可能会说，刘邦搞事业，拉着乡亲入伙很正常啊。<br />
从丰县县城向东南出发，一个半小时车程就会到达徐州。在秦代，这里叫彭城，项羽建立西楚，都城就是彭城。奇怪了，为什么项羽的都城离刘邦家这么近呢？<br />
继续向东南驱车一个半小时，会到达今天的宿迁市，在秦代，这里叫下相，项羽的故乡。你看，连项羽家距离刘邦家好像都不是很远。<br />
然后，从项羽的家乡向西出发，开车一个多小时，就会到达安徽省灵璧县，“霸王别姬”、“乌江自刎”的故事就发生在这附近。<br />
踩着油门朝西北走，不到一个小时，我们来到安徽省宿州市。在秦代，这里沼泽遍地，名叫大泽乡。没错，陈涉吴广起义，就发生在这里。<br />
是不是觉得有一个问题已经呼之欲出了？秦朝灭国的可是六国啊。齐楚燕赵魏韩，那么大一片地方啊。但是怎么在秦朝末年找麻烦的就集中在这么一小块地方呢？那么大片的地方不出事，偏偏就这里出事？<br />
对，佐竹靖彦给这一小块地方起了个名字：“泗水系月牙形水乡山泽地带”。<br />
在那个时代，这个地方是一片月牙形地带，泗水河川行而过，地势低、潮湿，形成了大量的水乡山泽。在秦代，这里有个地方叫大野泽。听这个名字，你就能感受到三个特点：水多、荒凉、面积大。后来随着大野泽不断缩小并且位移，到五代的时候，大野泽变成了梁山泊。<br />
一听到梁山泊，你就明白这个地方的意义了。官兵到不了嘛。</p>
</blockquote>
<p>另外，徐州还是汉帝国的掘墓者曹操起家之处，唐帝国覆灭者黄巢朱温老巢，巨盗宋江也就是在<a href="https://zhuanlan.zhihu.com/p/109906127">河北、河南、山东、江苏交接的地方来回变动</a></p>
<p>然后结合时事，为什么这里拐卖人口多？</p>
<p>很多摸鱼群的分析是孝文化，传宗接代的思想在作怪，什么养儿防老，养儿挣钱，但读到2020年这篇Yixi演讲的文章，我就不淡定了</p>
<p><a href="https://www.163.com/dy/article/GRIQSK0P05439A3X.html">吴心越：养老院调查真相，让老人恐惧，问题严重性超出你的想象！</a></p>
<blockquote>
<p>小时候，父母对孩子通常都是很强势的。但是随着年龄增长，你会发现父母对你越来越弱势，其实就是这个原因。养老院里那些无儿无女的老人，其实和学校里面的“孤儿”没有本质的区别，都属于被欺负的对象。在学校，父母是孩子的依靠。在养老院，子女其实就是老人的依靠。<br />
哪怕有些子女很混蛋，很不负责，但他是维权的直接受益人。也许子女没有孝顺的动力，但是却有替父母维权的动力。越是混蛋的子女，战斗力就越强，父母出了问题，他们能把养老院讹到破产！<br />
就拿护工来说，知道你有哮喘，偏要把你安排在通风不好的地方；知道你和谁有矛盾，偏要把你俩安排在一个房间；知道你腿脚不利索，偏要把你安排在楼层较高的房间；故意把你安排给有传染病或者大小便失禁的老人一个房间.....这种情况，尤其是在养老行业，从来就不是个案，而是普遍性的现象。<br />
如果找院方投诉，就相当于把护工得罪死了，只要护工不被开除，如果不换养老院，剩下的日子，老人的日子只会愈来愈难过。<br />
如果老人在外面有子女，起码护工还会有所忌惮，知道他自己做的太过分，会有人来闹，就会有所收敛。<br />
这个时候，老年人有子女的最大意义，就是出了问题，有人帮你喊冤，哪怕他仅仅是为了搞一笔钱。</p>
</blockquote>
<p>所以现在突然明白，为啥乡土中国，熟人社会，有拼命生娃的做法，讲究「孝」道了。这TM的是生存的最低保障，战略威慑能力啊。。。</p>
<p>如果说大型中心省会城市代表秩序和文明，那么徐州周边的几百公里没有大城市的平原村落里，就是社会正义能延生到的末端，这个时候，基层秩序只能由血缘绑定。即便是贩卖人口交换来的亲人。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-02-14T21:31:41+08:00">2022-02-14</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-02"  rel="bookmark" >
              <h2 class="card-title">笑话了千年刻舟求剑，水面搜救的图案却叫Victor Sierra</h2>
            </a>
            <p class="card-text"><p>今天的第一个收获，Victor Sierra这个搜救图案</p>
<p><img alt="" src="/images/2022/stdout-02-01.jpg" /></p>
<p><img alt="" src="/images/2022/stdout-02-02.jpg" /></p>
<p>来自 <a href="https://www.youtube.com/watch?v=aoXJfuPaFF8">Why This Zig-Zag Coast Guard Search Pattern is Actually Genius - Smarter Every Day 268</a>，是美国 coast guard 标准化的水面搜救路线<strong>之一</strong>。这种图案覆盖的面最大并且效率最高，而且最重要的一点，考虑到水是流动的，能够跟随一起漂流的相对速度去找到 PIW (person in water)</p>
<p>于是我就想起大家都熟悉的成语——「刻舟求剑」。这是2000多年前一个河南贩子吕不韦编的一个讥讽九头鸟的段子，由于这个成语太熟悉了，我甚至开始怀疑课本上是不是掐头去尾没讲完，跟之前那个「<a href="/202004/stdin-001">守株待兔</a>」恶毒的政治隐喻一样，于是去翻了下原文。好家伙，不能说雷同，简直就是一模一样。它出自《<a href="https://ctext.org/lv-shi-chun-qiu/cha-jin/zhs">吕氏春秋·察今</a>》</p>
<p>察今一共三段，第一段说，按着先人制度惯性因循守旧的人都是大沙雕；第二段说，荆州人拿了过期的水文资料强行过河结果沙币了。第三段说，好剑要的是锋利，不必是莫邪的名称；好马要的是能行千里，而不是骥骜的名称。成就功名的人，就是老板的好工具人。然后就抬出来了著名的讽刺湖北佬的段子：</p>
<div style="
    font-family: Baskerville, Georgia, &quot;Liberation Serif&quot;, &quot;Kaiti SC&quot;, STKaiti, &quot;AR PL UKai CN&quot;, &quot;AR PL UKai HK&quot;, &quot;AR PL UKai TW&quot;, &quot;AR PL UKai TW MBE&quot;, &quot;AR PL KaitiM GB&quot;, KaiTi, KaiTi_GB2312, DFKai-SB, &quot;TW\-Kai&quot;, serif;
    writing-mode: vertical-rl;
    width: 100%;
    word-break: break-all;
    white-space: pre;
    text-spacing: ideograph-alpha;
    border-right: 0.2em solid #e00711;
    text-align: justify;
    text-justify: inter-ideograph;
">
楚人有涉江者，其剑自舟中坠于水，遽契其舟，
曰：「是吾剑之所从坠。」舟止，从其所契者入水求之。
舟已行矣，而剑不行，求剑若此，不亦惑乎？

以此故法为其国与此同。
时已徙矣，而法不徙，以此为治，岂不难哉？

有过于江上者，见人方引婴儿而欲投之江中，
婴儿啼，人问其故，曰：「此其父善游。」
其父虽善游，其子岂遽善游哉？
此任物亦必悖矣。荆国之为政，有似于此。
</div>

<p>第二个收获就是，果不其然又是一个阴阳怪气讽刺朝政的段子。看来每一个成语背后都有一个键政的动机哎。</p>
<p>第三个收获，没想到刻舟求剑之后，还有个「其父善游」的更离谱段子卧槽。。。</p>
<p>然后突然就想到了近期第四个收获，<a href="https://www.zhihu.com/question/511590823">王中林院士拓展麦克斯韦方程组</a>，在渣乎上看的一路下来，无论是懂哥，还是路人，几乎全是在喷。但是恰好就<a href="https://news.ycombinator.com/item?id=29977041">在 HN</a> 有人投递了一则如何通过伽利略旋转和洛伦兹旋转认识特种相对论的线串</p>
<p><a href="https://twitter.com/MarkusDeserno/status/1482811504424542211">https://twitter.com/MarkusDeserno/status/1482811504424542211</a></p>
<p><img alt="" src="/images/stdout-02-03.jpg" /></p>
<p>其中从 <code>arctan(m12) = arctan(m1) + arctan(m2)</code> 推到 <code>tan(x+y) = [tan(x) + tan(y)] / [1 – tan(x)·tan(y)]</code></p>
<p>再到 <code>m12 = [m1 + m2] / [1 – m1·m2]</code></p>
<p>好吧，我也假装我看懂了！</p>
<p>最后一个感触，大家都顾着去看2500年前楚国人和当今院士的笑话了，却很少有人正面分析一下问题。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-01-19T23:15:24+08:00">2022-01-19</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2022/stdout-01"  rel="bookmark" >
              <h2 class="card-title">python-phoenixdb 设置读取超时</h2>
            </a>
            <p class="card-text"><p>PhoenixDB 居然是基于 requests + pb2 做的传输层协议。连接的是 queryserver 的 http 接口</p>
<p>看 <a href="https://git-wip-us.apache.org/repos/asf?p=phoenix-queryserver.git;a=blob;f=python-phoenixdb/phoenixdb/avatica/client.py">avatica/client.py 源码</a> 可以得知这玩意默认是不支持设置read timeout的。强行hack一个：</p>
<pre><code>import phoenixdb
import functools
c = phoenixdb.connect('http://localhost:8765/', autocommit=True, auth=&quot;SPNEGO&quot;)
c._client.session.request = functools.partial(c._client.session.request, timeout=2)
</code></pre>
<p><code>partial</code> 这个神奇的魔法可以设置一个默认参数。其它地方传入了别的timeout也可以自行覆盖，无缝兼容。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2022-01-11T12:00:56+08:00">2022-01-11</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-028"  rel="bookmark" >
              <h2 class="card-title">Microsoft 官网的 403 错误</h2>
            </a>
            <p class="card-text"><pre><code>$ curl -H &quot;User-Agent: User-Agent: Mozilla/5&quot; -kvs 'http://www.microsoft.com'
*   Trying 118.123.102.107...
* TCP_NODELAY set
* Connected to www.microsoft.com (118.123.102.107) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; Host: www.microsoft.com
&gt; Accept: */*
&gt; User-Agent: User-Agent: Mozilla/5
&gt;
&lt; HTTP/1.1 403 Forbidden
&lt; Server: GHost
&lt; Content-Length: 306
&lt; Content-Type: text/html
&lt; Mime-Version: 1.0
&lt; Expires: Wed, 29 Dec 2021 14:42:28 GMT
&lt; Cache-Control: max-age=0, no-cache
&lt; Pragma: no-cache
&lt; Date: Wed, 29 Dec 2021 14:42:28 GMT
&lt; Connection: keep-alive
&lt;
&lt;HTML&gt;&lt;HEAD&gt;
&lt;TITLE&gt;Access Denied&lt;/TITLE&gt;
&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;Access Denied&lt;/H1&gt;

You don't have permission to access &quot;http&amp;#58;&amp;#47;&amp;#47;mscom&amp;#46;errorpage&amp;#46;failover&amp;#46;com&amp;#47;403&amp;#47;403&amp;#46;htm&amp;#63;&quot; on this server.&lt;P&gt;
Reference&amp;#32;&amp;#35;18&amp;#46;1c697b76&amp;#46;1640788948&amp;#46;3b971c1f
&lt;/BODY&gt;
&lt;/HTML&gt;
* Connection #0 to host www.microsoft.com left intact
* Closing connection 0
</code></pre>
<p>不知道为何会指向  <code>http://mscom.errorpage.failover.com</code> 这域名也不是微软的。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-12-29T22:42:14+08:00">2021-12-29</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-027"  rel="bookmark" >
              <h2 class="card-title">Chrome 阉割指南</h2>
            </a>
            <p class="card-text"><p>不折腾不舒服。继之前 <a href="/2021/stdout-020">Edge调教</a> 之后记录一下 Chrome V70怎么阉割。</p>
<p>下载：</p>
<p><a href="https://dl.google.com/edgedl/release2/chrome/ALiXMYM2w8-h_70.0.3538.77/70.0.3538.77_chrome_installer.exe">win 32</a> | <a href="https://dl.google.com/edgedl/release2/chrome/AJ7ozxk4OLvN_70.0.3538.77/70.0.3538.77_chrome_installer.exe">win 64</a> | <a href="https://redirector.gvt1.com/release2/chrome/AIJolai8dEil_70.0.3538.67/GoogleChrome-70.0.3538.67.dmg">Mac</a></p>
<p>上面的链接已经年久失修了，对比了一下获取最新版本的脚本发现 Google 已经不提供老链接了。</p>
<pre><code>curl -vsk 'https://tools.google.com/service/update2' -HContent-Type:text/xml --data-binary &quot;&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;request protocol='3.0' sessionid='{est-blog}' installsource='ondemandcheckforupdate' dedup='cr'&gt;
&lt;os platform='mac' version='66.6.6666.66' arch='x64'/&gt;
&lt;app appid='com.google.Chrome' ap='' version='' nextversion='' lang='' brand='GGLS' client=''&gt;&lt;updatecheck/&gt;&lt;/app&gt;
&lt;/request&gt;&quot;
</code></pre>
<p>安装完毕之后</p>
<pre><code>cd '/Applications/Google Chrome.app/Contents'
touch Frameworks
sudo chown root:wheel Frameworks
sudo chmod 000 Frameworks

cd ~/Library/Google
rm -rf GoogleSoftwareUpdate
touch GoogleSoftwareUpdate
sudo chown root:wheel GoogleSoftwareUpdate
sudo chmod 000 GoogleSoftwareUpdate
</code></pre></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-12-28T23:00:05+08:00">2021-12-28</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-026"  rel="bookmark" >
              <h2 class="card-title">认识「洋节」</h2>
            </a>
            <p class="card-text"><p>都说 xmas eve 是洋节，我们就来数一数到底有哪些洋节</p>
<ol>
<li>元旦1月1日。由北「洋」军阀袁世凯设立。依据是内务部总长朱启钤《定四季节假呈》，把原来农历（夏历）的正月初一的「元旦」挪用到了格里历一月一日。格里历(Gregorian calendar)引入中国是1912，元旦正式生效是1914年。</li>
<li>春节。严格的来说，传统春节是二十四节气中的“立春”，是太阳历。后来被袁世凯直接拍板成农历正月初一。而夏历正月初一一般被认为是最接近立春之朔日（月缺之日）。农历最后一次农历大改版为《授时历》，发生在崇祯二年（1629年）九月，由礼部左侍郎徐光启发起，编撰者：耶稣会的龙华民（西西里人）、罗雅谷（米兰人）、邓玉函（瑞士人）、汤若望（日耳曼人）。</li>
<li>生肖其实不跟农历绑定，而是跟 二十四节气绑定。二十四节气最后一次改版，也是上面那个《时宪历》那帮洋传教士定下来的。有意思的是，春分那一天恰好开始白羊座，其实我最近才知道二十四节气就约等于12星座，也就是黄道十二宫。如果要说农历《时宪历》含洋量太高，那么他之前的《授时历》编撰者是河北人郭守敬，生于元太宗(窝阔台)三年（1231年）于邢州，由他祖父郭荣(金国人)抚养成人，说起来这老兄甚至顺着蒙古人统治下的锡伯利亚去过北极科考，同一位尼泊尔建筑师阿尼哥合作搞过天文台，十分了得。</li>
<li>妇女节，全称为「“三八”国际劳动妇女节」。1857年3月8日，美国纽约的制衣和纺织女工走上街头，抗议恶劣的工作条件和低薪。尽管后来当局出动警察攻击并驱散了抗议人群，但这次抗议活动促成了两年后的3月第一个工会组织的建立。1917年3月8日，在俄罗斯帝国首都彼得格勒，纺织女工举行罢工及游行，遍及整个城市，也导致俄罗斯革命的开始。</li>
<li>清明节，二十四节气之一。太阳到达黄经15°</li>
<li>劳动节，1884年，劳动骑士团 Knights of Labor 倡导「8小时工作制」；10月，行会与工会联盟召开大会确定1886年5月1日为要求八小时工作制成为标准的日期，美国工会准备举行总罢工支援；1886年5月1日，数千名参加罢工和参加全美各地举行的集会的工人唱起了《八小时》（Eight Hour）一歌；接下来发生干草市场屠杀(Haymarket affair)。</li>
<li>端午节，据传是为了纪念<a href="/202006/stderr-008">恨国诗人屈原</a>，来自「蛮夷」楚国</li>
<li>儿童节。1949年11月国际民主妇女联合会在苏联莫斯科所召开的执行委员会议，会上为纪念悼念1942年捷克利迪策村对儿童的屠杀及伤害，以及全世界所有在法西斯侵略战争中死难的儿童，为保障世界各国儿童的生存权、保健权和受教育权及改善儿童的生活，决议以6月1日为国际儿童节。1949年12月23中央人民政府政务院第十二次政务会议于日通过了《全国年节及纪念日放假办法》，其中规定6月1日为儿童节。</li>
<li>建军节，由 契丹苏维埃共和国 (Kitajskaja Sovetskaja Respublika, Кита́йская Сове́тская Респу́блика) 于1933年6月决定，将8月1日定为中国工农红军的建军节。<br />
<img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/National_Flag_of_Chinese_Soviet_Republic.svg/400px-National_Flag_of_Chinese_Soviet_Republic.svg.png" /></li>
<li>圣纪节，穆罕默德的诞辰与逝世恰巧都在伊斯兰教历三月十二日，回回三大节之一。<br />
<img alt="" src="http://wx1.sinaimg.cn/large/4b18c48fly4glz8qsahmzj20kw0fmdia.jpg" /></li>
</ol>
<p>再说一下真正被 appropriation 的「洋节」</p>
<ol>
<li>圣诞节。异教徒的节日，四舍五入冬至日，古埃及太阳神 Ra 的节日，被(东)罗马帝国拿来宣传成中东人耶稣的生日。。。摊手。。。比如犹太人就不过圣诞节，但是他们在这一天<a href="https://www.youtube.com/watch?v=Ny3PQOWsUGs">吃中餐</a></li>
<li>母亲节，由12岁女孩安娜·贾维斯(Anna Jarvis)发起，被商家利用，安娜用<a href="https://www.sohu.com/a/313400538_782639">下半辈子反对母亲节</a></li>
<li>父亲节：抄袭母亲节。</li>
</ol></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-12-24T23:59:59+08:00">2021-12-24</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-025"  rel="bookmark" >
              <h2 class="card-title">如何可视化跟踪分析 Python import 耗时</h2>
            </a>
            <p class="card-text"><p>首先在本地安装 <code>pip install tuna</code></p>
<p>然后跑个分，需要 <code>CPython &gt;= 3.7</code>，输入</p>
<p><code>PYTHONPROFILEIMPORTTIME=1 python3 myscript.py 2&gt;1.log</code></p>
<p><img alt="tuna" src="https://camo.githubusercontent.com/d76ac242a42f9c394c1ae66da655173a51d9ed9c09107dd8d42b684c15aa2d05/68747470733a2f2f6e7363686c6f652e6769746875622e696f2f74756e612f666f6f2e706e67" /></p>
<p>然后 <code>tuna 1.log</code> ，会自动打开浏览器围观 <code>import</code> 耗时分布。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-12-22T14:00:28+08:00">2021-12-22</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-023"  rel="bookmark" >
              <h2 class="card-title">FastAPI/Starlette支持静态文件支持SPA</h2>
            </a>
            <p class="card-text"><p>FastAPI 官方支持 <code>from fastapi.staticfiles import StaticFiles</code> 充当一个静态文件服务器</p>
<p>其实实现是 starlette。这玩意可以在 <code>directory</code> 下放一个 <code>404.html</code>，恰好单页应用也需要用 <code>index.html</code> 充当所有 javascript 框架注册的 router</p>
<p>只是有一个毛病，这货返回的 HTTP status code 是 404。用起来没啥大毛病，但是就是浏览器不会记录网址，导致没法匹配浏览历史快速找到之前访问过的页面。</p>
<p>拿来改改继续用</p>
<pre><code>  from starlette.staticfiles import StaticFiles, Scope, Headers, Response, FileResponse

  class StaticFilesWithout404(StaticFiles):
      async def get_response(self, path: str, scope: Scope) -&gt; Response:
          r = await super().get_response(path, scope)
          h = Headers(scope=scope)
          full_path, stat_result = await self.lookup_path('404.html')
          if isinstance(r, FileResponse) and r.path == full_path:
              if 'text/html' in (h.get('accept') or ''):
                  r.status_code = 200
              else:
                  return Response('', status_code=404)
          return r

  app.mount("/frontend", StaticFilesWithout404(directory="frontend", html=True), name="static")
</code></pre>
<p>这段代码大概是起到了类似 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#try_files">nginx <code>try_files</code></a> 的作用。默认静态文件映射一个目录，但是如果找不到就按根目录的 index.html 输出。这里还判断了请求的 <code>accept</code> 头，如果是 xhr/Fetch 就会直接返回一个0字节长度无MIME的404。</p>
<p>由此我想到了一个学究式的 leaky abstraction。众所周知，如果一个URL不存在，那么服务器应该返回404</p>
<p>但是现在都是 SPA 单页应用，都是先 200 返回 <code>index.html</code> 的内容，再由 javascript 的 router 去决定是否正常显示还是404 。所以返回 200 但是显示 404 就破坏了这个语义。如果要精确匹配SPA里的router如果不存在由服务器返回404，第一是搞 SSR，把前端那一坨代码跑在服务器端，第二种办法是 npm build 的时候输出一个可路由URL列表，然后部署的时候导入静态文件服务器更新。这个具体实现就留作homework由读者自行解决了。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-12-08T07:38:38+08:00">2021-12-08</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-022"  rel="bookmark" >
              <h2 class="card-title">人工构造Flask session模拟cookie登陆</h2>
            </a>
            <p class="card-text"><p>有没有好奇为什么 Flask 配置必须要求一个 <a href="https://flask.palletsprojects.com/en/latest/config/#SECRET_KEY">SECRET_KEY</a>，然后就可以在浏览器保存一个 session 状态读写数据。</p>
<p>这里记一下它的底层实现，其实需要依赖的包是 <a href="https://itsdangerous.palletsprojects.com/">itsdangerous</a></p>
<pre><code>  import hashlib
  from itsdangerous import URLSafeTimedSerializer
  URLSafeTimedSerializer(
          'YOUR_SECRET_KEY',  # flask SECRET_KEY
          'cookie-session',  # from flask.sessions.SecureCookieSessionInterface.salt
          # serializer=TaggedJSONSerializer(),
          signer_kwargs={'key_derivation': 'hmac', 'digest_method': hashlib.sha1}
  ).dumps({
      "your_key": "your_value"
  })
</code></pre>
<p>别人如果拿到你的 <code>SECRET_KEY</code> 就可以伪造任意 session cookie 了</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-12-08T07:15:03+08:00">2021-12-08</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-021"  rel="bookmark" >
              <h2 class="card-title">Python 3.X ctypes 和 greenlet size changed 坑三则</h2>
            </a>
            <p class="card-text"><h3>安装 setup.py 的时候 <code>No module named '_ctypes'</code> 报错</h3>
<pre><code>  Traceback (most recent call last):
    File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
    File &quot;/usr/local/python3/lib/python3.9/site-packages/setuptools/__init__.py&quot;, line 18, in &lt;module&gt;
      from setuptools.dist import Distribution
    File &quot;/usr/local/python3/lib/python3.9/site-packages/setuptools/dist.py&quot;, line 34, in &lt;module&gt;
      from setuptools import windows_support
    File &quot;/usr/local/python3/lib/python3.9/site-packages/setuptools/windows_support.py&quot;, line 2, in &lt;module&gt;
      import ctypes
    File &quot;/usr/local/python3/lib/python3.9/ctypes/__init__.py&quot;, line 8, in &lt;module&gt;
      from _ctypes import Union, Structure, Array
  ModuleNotFoundError: No module named '_ctypes'
</code></pre>
<p>解决办法是不要用 3.9。</p>
<p>如果实在要用，则自己编译前需要加上 <code>yum install libffi-devel</code> 或者 <code>sudo apt-get install libffi-dev</code></p>
<p>来自<a href="https://stackoverflow.com/a/48045929">SO</a></p>
<h3><code>greenlet.greenlet size changed</code> 然后出错</h3>
<pre><code>/usr/local/lib/python3.7/importlib/_bootstrap.py:219: RuntimeWarning: greenlet.greenlet size changed, may indicate binary incompatibility. Expected 144 from C header, got 152 from PyObject
  return f(*args, **kwds)
/usr/local/lib/python3.7/importlib/_bootstrap.py:219: RuntimeWarning: greenlet.greenlet size changed, may indicate binary incompatibility. Expected 144 from C header, got 152 from PyObject
  return f(*args, **kwds)

Segmentation fault (core dumped)
</code></pre>
<p>这个摘自<a href="https://github.com/gevent/gevent/issues/1260">官方 iseue</a></p>
<blockquote>
<p>On Python 3.7 and higher, gevent 20.9.0 is required to use (a standard build of) greenlet 0.4.17.</p>
</blockquote>
<p>解决办法：<code>pip install gevent==20.9.0 pip install greenlet==0.4.17</code></p>
<h3>SQLAlchemy 1.4 大战 greenlet 0.4.17</h3>
<p>见 <a href="https://docs.sqlalchemy.org/en/14/changelog/changelog_14.html#change-12b8eb8e600cc32590b51d0087552191">sqlalchemy changelog</a></p>
<blockquote>
<p>to accommodate for the handling of Python contextvars (introduced in Python 3.7) for greenlet versions greater than 0.4.17. Greenlet version 0.4.17 added automatic handling of contextvars in a backwards-incompatible way; we’ve coordinated with the greenlet authors to add a preferred API for this in versions subsequent to 0.4.17 which is now supported by SQLAlchemy’s greenlet integration. For greenlet versions prior to 0.4.17 no behavioral change is needed, version 0.4.17 itself is blocked from the dependencies.</p>
</blockquote>
<p>然后就直接在 <a href="https://github.com/sqlalchemy/sqlalchemy/blob/703ff387c13f083ed0982071963155d679c862ab/setup.cfg#L42">setup.cfg里</a> 给 <code>greenlet != 0.4.17</code>了。</p>
<p>神仙打架，不听不听，和尚念经，果断 <code>sqlalchemy==1.3.24</code> 降级。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-12-01T17:41:32+08:00">2021-12-01</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-020"  rel="bookmark" >
              <h2 class="card-title">Edge调教指南——如何设置本地PAC代理和首页天气</h2>
            </a>
            <p class="card-text"><p>之前一直用的chrome v70，为什么呢？</p>
<p>第一是这个老版本允许 <code>--proxy-pac-url="file:///Users/me/1.pac</code> 这样设置，但是<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=839566">Chromium项目的大爷们觉得</a>你本地的.pac不够安全，要网上的.pac才安全，所以一刀切给禁了。当然有热心人士觉得这没啥大不了的。不外乎装个插件就可以切PAC。但是chrome插件其实会有一个fingerprint。Extension一启用，隔壁老王都知道你开代理了。</p>
<p>第二，也是最重要的原因，这是最后一个chrome版本支持 <code>about://net-internals</code> 在本地查看浏览器底层网络请求。现在无论是 Edge 还是 Chrome 都必须把 .json 文件从 https://netlog-viewer.appspot.com/ 加载才能看了。很尼玛保护了隐私有没有啊。</p>
<p>但是坚持老版本，也付出了巨大的代价。很多新的 ES 语法不支持，比如说 Grafana 最新版 login 都进不去。这就尴尬了。只能被自愿升级了。</p>
<p>既然升级是必选项，那么就换 Edge 试试。</p>
<p>第一就是得解决这个本地 .pac 问题，其实从上面第二个工具里才能知道，PAC加载失败有个返回 <code>ERR_DISALLOWED_URL_SCHEME</code>。stackoverflow 上找到个奇技淫巧</p>
<p><code>open "/Applications/Microsoft Edge.app" --args --proxy-pac-url='data:application/x-javascript-config;base64,'$(base64 -i /Users/me/2.pac)</code></p>
<p>还能这样玩？双击666。</p>
<p>第二个把该禁用的禁用了，首页只留一个搜索框一个天气。但是这天气就特么定位到坡县了。而且下拉框点不出来啊。F12打开 devtool 一看，我尼玛好家伙 <code>https://www.bing.com/api/v6/Places/AutoSuggest</code> 被 Bing China 的网管给一把梭302到 <code>https://cn.bing.com/api/v6/Places/AutoSuggest</code> 了。然后就特么 CORS 给拦截，js读取不到列表。。。</p>
<p>最后怎么办？点那个天气图标，进入到 <code>https://www.msn.com/en-sg/weather/today/weather-today/we-city</code></p>
<p>然后找那个地图，手动选择自己所在城市，设置为 Home 。等 cookie 写入生效了，打开edge新tab就ok了</p>
<p>这年头上个网真鸡儿累。</p>
<p>btw 设置M$账号同步的时候，发现账号所在国家可以选很多不是国家的地方，但是时区就不能随便选了。F12改了也没用。微软的后台开发做的过滤还挺细致的。</p>
<p>btw2 发现一个很干净的启动页： <code>chrome-search://local-ntp/local-ntp.html</code> 或者直接在 <code>hosts</code> 里把 ntp.msn.com 干掉，有奇效。</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-11-30T11:32:33+08:00">2021-11-30</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-019"  rel="bookmark" >
              <h2 class="card-title">TiDB不支持JSON字段默认值</h2>
            </a>
            <p class="card-text"><p>继前面的<a href="/2021/stdout-011">日期不兼容</a>坑，又发现<a href="https://docs.pingcap.com/tidb/stable/data-type-default-values">一个</a></p>
<blockquote>
<p>The BLOB, TEXT, and JSON columns cannot be assigned a default value.</p>
</blockquote>
<p>虽然 <a href="https://dev.mysql.com/doc/refman/5.7/en/json.html">MySQL 5.7 也是这么说</a>的：</p>
<blockquote>
<p>A JSON column cannot have a non-NULL default value.</p>
</blockquote>
<p>但是 <a href="https://dev.mysql.com/doc/refman/8.0/en/data-type-defaults.html">MySQL 8.0.13 就支持指定默认值</a>了</p>
<blockquote>
<p>Prior to MySQL 8.0.13, a JSON column cannot have a non-NULL default value.<br />
The default value specified in a DEFAULT clause can be a literal constant or an expression. With one exception, enclose expression default values within parentheses to distinguish them from literal constant default values. Examples:</p>
</blockquote>
<p>虽然语法很丑但是很实用啊。</p>
<p>所以这种语句</p>
<pre><code>  ALTER TABLE mytable MODIFY COLUMN my_json JSON DEFAULT (json_object());
</code></pre>
<p>在 TiDB 里就没法支持。这也带来一个问题，就是要 upsert 这个 字段的时候，写起来就很拧巴，以 <code>peewee</code> 这个ORM为例：</p>
<pre><code>  MyTable.update({
      'my_json' = fn.json_set(
          fn.COALESCE(MyTable.my_json, Cast('{}', 'JSON')),
          '%.some_key', 'some_value',
  )})
</code></pre>
<p>必须用 COALESCE 预防默认值为 <code>NULL</code> 的情况。太麻烦了。</p>
<p>btw 玩MySQL/TiDB的 JSON 有个坑的，那就是 json 的 <code>null</code> 是有值的，和 sql 的 <code>NULL</code> 是不同的。</p>
<p>也就是说</p>
<pre><code>  select json_extract('{}', '$.hey') IS NULL;
  select json_extract('{"hey": null}', '$.hey') = Cast('null' as JSON);
</code></pre>
<p>要注意。</p>
<p>btw2 MySQL的JSON数据抽取 <code>-&gt;&gt;</code> 是返回真正的值，等价于TiDB里的 json_unquote(json_extract(t.json_field, '$.key1.key2'))</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-11-19T09:14:28+08:00">2021-11-19</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-016"  rel="bookmark" >
              <h2 class="card-title">Chrome 指定域名解析，绕过 hosts</h2>
            </a>
            <p class="card-text"><p>看到 <a href="https://www.v2ex.com/t/813626">V站有人问</a>这个，随手一记</p>
<p>可以参考<a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/components/network_session_configurator/common/network_switch_list.h">源码里的注释文档</a></p>
<h2>--host-resolver-rules=rules</h2>
<p>Like <code>--host-rules</code> but these rules only apply to the host resolver.<br />
A comma-separated list of rules that control how hostnames are mapped.<br />
For example:<br />
- <code>MAP * 127.0.0.1</code> Forces all hostnames to be mapped to <code>127.0.0.1</code><br />
- <code>MAP *.google.com proxy</code> Forces all google.com subdomains to be resolved to <code>proxy</code>.<br />
- <code>MAP test.com [::1]:77</code> Forces <code>test.com</code> to resolve to IPv6 loopback. Will also force the port of the resulting socket address to be 77.<br />
- <code>MAP * baz, EXCLUDE www.google.com</code> Remaps everything to <code>baz</code>, except for <code>www.google.com</code>.</p>
<p>These mappings apply to the endpoint host in a net request (the TCP connect and host resolver in a direct connection, and the CONNECT in an HTTP proxy connection, and the endpoint host in a SOCKS proxy connection).</p>
<p>官方文档有语焉不详的提到过</p>
<p>https://chromium.googlesource.com/chromium/src/+/refs/heads/main/net/dns/README.md</p>
<blockquote>
<p>Starting Chrome with --host-resolver-rules="MAP the.hostname.com [dead::beef]" where the.hostname.com is the hostname to allow resolving and dead::beef is the IPv6 address to resolve it to. net::MappedHostResolver acts at a level before IPv6 connectivity checks, and if a hostname is remapped to an IP literal, connectivity checks do not apply.</p>
</blockquote>
<p>还有很多 <a href="https://chromium.googlesource.com/chromium/src/+/HEAD/net/docs/proxy.md">proxy的参数</a></p>
<h2>curl 的参数</h2>
<p>也顺便贴一下。调试的时候用得上</p>
<p>参数：</p>
<ul>
<li><code>-4</code>, <code>--ipv4</code></li>
<li><code>-6</code>, <code>--ipv6</code></li>
<li><code>--dns-interface &lt;interface&gt;</code></li>
<li><code>--dns-ipv4-addr &lt;ip-address&gt;</code> Tell curl to bind to <code>&lt;ip-address&gt;</code> when making IPv4 DNS requests</li>
<li><code>--dns-ipv6-addr &lt;ip-address&gt;</code> Tell curl to bind to <code>&lt;ip-address&gt;</code> when making IPv6 DNS requests</li>
<li><code>--dns-servers &lt;ip-address,ip-address&gt;</code> Set the list of DNS servers to be used instead of the system default. The  list  of  IP  addresses should  be  separated  with commas. Port numbers may also optionally be given as <code>:&lt;port-number&gt;</code> after each IP address.</li>
<li><code>--resolve &lt;host:port:address&gt;</code> Make the curl requests(s) use a specified address and prevent the otherwise normally resolved address to  be  used. Consider  it a sort of /etc/hosts alternative provided on the command line. The port number should be the number used for the specific protocol the host will be  used  for.  It  means  you  need  several entries if you want to provide address for the same host but different ports. This option can be used many times to add many host names to resolve. (Added in 7.21.3)</li>
</ul>
<p>最后一个很有用 😹</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-11-07T16:01:19+08:00">2021-11-07</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-017"  rel="bookmark" >
              <h2 class="card-title">reverse proxy FastCGI (fcgi) with uWSGI</h2>
            </a>
            <p class="card-text"><p>People are still using FastCGI, and it's hard. I used uWSGI to convert FCGI traffic to regular http/1.0 so I can keep my existing http service running without apache mod_fcgi shit.</p>
<h2>CGI environ variables</h2>
<p>This is some ancient knowledge, better keep them noted</p>
<table>
<thead>
<tr>
<th>KEY</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>AUTH_TYPE</td>
<td>ignore this</td>
</tr>
<tr>
<td>REMOTE_IDENT</td>
<td>The user making the request.</td>
</tr>
<tr>
<td>REMOTE_USER</td>
<td>The authenticated name of the user making the query.</td>
</tr>
<tr>
<td>CONTENT_LENGTH</td>
<td>byte length of body</td>
</tr>
<tr>
<td>CONTENT_TYPE</td>
<td>MIME such as text/html, without the charset shit</td>
</tr>
<tr>
<td>DOCUMENT_ROOT</td>
<td>NEW. The directory from which web documents are served.</td>
</tr>
<tr>
<td>REQUEST_URI</td>
<td>NEW. confusing shit similar with PATH_INFO</td>
</tr>
<tr>
<td>HTTP_*</td>
<td>HTTP headers</td>
</tr>
<tr>
<td>PATH_INFO</td>
<td>like /a/b/c</td>
</tr>
<tr>
<td>PATH_TRANSLATED</td>
<td>not really used</td>
</tr>
<tr>
<td>QUERY_STRING</td>
<td>the part after ? in an URL</td>
</tr>
<tr>
<td>REMOTE_ADDR</td>
<td>client IP</td>
</tr>
<tr>
<td>REMOTE_HOST</td>
<td>client host name by lookup ip</td>
</tr>
<tr>
<td>REQUEST_METHOD</td>
<td>GET/POST</td>
</tr>
<tr>
<td>SCRIPT_NAME</td>
<td>The virtual path (e.g., /cgi-bin/program.pl) of the script being executed.</td>
</tr>
<tr>
<td>SCRIPT_FILENAME</td>
<td>confusing shit similar with SCRIPT_NAME</td>
</tr>
<tr>
<td>SERVER_NAME</td>
<td>The server's hostname or IP address.</td>
</tr>
<tr>
<td>SERVER_PORT</td>
<td>The port number of the host on which the server is running.</td>
</tr>
<tr>
<td>SERVER_PROTOCOL</td>
<td>The name and revision number of the server protocol.</td>
</tr>
</tbody>
</table>
<h2>reverse proxy FastCGI with uWSGI</h2>
<p>slap this into <code>my_conf.ini</code></p>
<pre><code>  [uwsgi]
  my_port = 9000  # can be set otherwise
  route-run = addvar:SERVER_NAME=%h
  route-run = addvar:SERVER_PORT=%(my_port)
  route-if  = empty:${REQUEST_METHOD} addvar:REQUEST_METHOD=GET
  route-if  = empty:${HTTP_HOST} addvar:HTTP_HOST=%h:%(my_port)
  route-run = seturi:/fcgi-proxy${PATH_INFO}
  route-run = http:127.0.0.1:9527
  fastcgi-socket = 0.0.0.0:%(my_port)
  http-socket = 0.0.0.0:8000  # for testing purpose.
</code></pre>
<p>Install uWSGI, install the binary from pypi wheels instead of compiling uwsgi.c shit</p>
<pre><code>  pip install pyuwsgi
</code></pre>
<p>Run it</p>
<pre><code>  uwsgi --ini my_conf.ini
</code></pre>
<p>Now you can run your regular http service behind <code>127.0.0.1:9527</code>, while serving fcgi on <code>127.0.0.1:9000</code></p>
<p>Requests like <code>fcgi://127.0.0.1:9000/hello</code> will be fowwarded to <code>http://127.0.0.1:9527/fcgi-proxy/hello</code></p>
<p>You may ask why adding a <code>/fcgi-proxy</code> in path? Because there's a gotcha.</p>
<h2>fuckedup FastCGI requests</h2>
<p>Learned this from some php-fpm tutorial, first install the standard fcgi client tool because <code>curl</code> doesn't speak fcgi.</p>
<pre><code>  apt-get install libfcgi0ldbl
  yum --enablerepo=epel install fcgi
  SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:9000
</code></pre>
<p>You can observe from uWSGI logs that <code>cgi-fcgi</code> command sends flawed requests, the <code>PATH_INFO</code> was unset.</p>
<p>After hours wasted, I came up with a clever hack to force uWSGI's internal router to force <code>seturi</code> with a path prefix</p>
<h2>ToDo</h2>
<p>There are further problems that can be improved, for example, my http service is running <code>uvicorn</code>, it can not guess the client ip:port infor from its stupid <code>get_remote_addr</code></p>
<p>what's worse, the uWSGI <code>addheader</code> directive are for <em>responses</em>, so I can't add <em>request</em> headers like <code>x-forwared-for</code>.</p>
<p>Also the reverse proxy is HTTP/1.0 only. to make the <code>Connection: Keep-alive</code> happen needs some further investigation.</p>
<h2>Q&amp;A</h2>
<p>Thanks for reading my shitpost. Questions?</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-11-05T18:12:45+08:00">2021-11-05</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-018"  rel="bookmark" >
              <h2 class="card-title">淘宝同一手机最多绑定6个小号</h2>
            </a>
            <p class="card-text"><p>总结一些没用的知识</p>
<ol>
<li>
<p>淘宝/阿里账号，可以一个手机最多绑定6个账号。淘宝注册的时候点击「企业注册」然后用邮箱注册，最后用同一个手机验证即可</p>
</li>
<li>
<p>「支付宝」在淘宝/阿里系里app里是和「账号」一一绑定的，这就产生了很多冲突。比如你一个第三方外卖app，支付的时候可以选择 微信/支付宝，一般不会限制下单手机号和支付手机号是否一样，你甚至可以帮别人支付订单，但是淘宝/阿里的app不一样，只能自己账号支付自己账号的订单。如果你有两个手机号和两个支付宝账号，那么没法交叉支付。</p>
</li>
</ol>
<p>还有一个想不起了，想起了再补充。2333</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-10-28T16:21:23+08:00">2021-10-28</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-015"  rel="bookmark" >
              <h2 class="card-title">《兵车行》竖排实验</h2>
            </a>
            <p class="card-text"><p>群里闲聊起究竟生男好还是生女好，就想起了这首诗</p>
<div style="
    font-family: Baskerville, Georgia, &quot;Liberation Serif&quot;, &quot;Kaiti SC&quot;, STKaiti, &quot;AR PL UKai CN&quot;, &quot;AR PL UKai HK&quot;, &quot;AR PL UKai TW&quot;, &quot;AR PL UKai TW MBE&quot;, &quot;AR PL KaitiM GB&quot;, KaiTi, KaiTi_GB2312, DFKai-SB, &quot;TW\-Kai&quot;, serif;
    writing-mode: vertical-rl;
    width: 100%;
    word-break: break-all;
    white-space: pre;
    text-spacing: ideograph-alpha;
    border-right: 0.2em solid #e00711;
    text-align: justify;
    text-justify: inter-ideograph;
">兵车行——杜甫

车辚辚，马萧萧，行人弓箭各在腰。  
耶娘妻子走相送，尘埃不见咸阳桥。
牵衣顿足拦道哭，哭声直上干云霄。
道旁过者问行人，行人但云点行频。
或从十五北防河，便至四十西营田。
去时里正与裹头，归来头白还戍边。
边庭流血成海水，武皇开边意未已。
君不闻，汉家山东二百州，千村万落生荆杞。
纵有健妇把锄犁，禾生陇亩无东西。
况复秦兵耐苦战，被驱不异犬与鸡。
长者虽有问，役夫敢申恨？
且如今年冬，未休关西卒。
县官急索租，租税从何出？
<b>信知生男恶，反是生女好。
生女犹得嫁比邻，生男埋没随百草。</b>
君不见，青海头，古来白骨无人收。
新鬼烦冤旧鬼哭，天阴雨湿声啾啾！

</div>

<p>测试下 css 的文字竖排。</p>
<p>字体来自 <a href="http://zenozeng.github.io/fonts.css/">fonts.css</a></p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-10-21T23:28:21+08:00">2021-10-21</time></p>
<p>stdout</p>            </div>
          </article>
        </div>


        <!-- new article -->
        <div class="card blog-card">
          <article class="card-body">
            <a href="/2021/stdout-014"  rel="bookmark" >
              <h2 class="card-title">Re-index page on Google Search Console</h2>
            </a>
            <p class="card-text"><p>Request indexing webpage with Google used to be fun and simple, now it's a tedious task especially when you have tons of old pages ready to be crawled yet Google is reluctant to move.</p>
<p>Here is a simple script to speed up the stacks of page you have click in order to submit multiple missing pages to Google. </p>
<p>Open your <a href="https://search.google.com/search-console">Google Search Console</a>, click <strong>Coverage</strong> then open <strong>Discovered – currently not indexed</strong></p>
<p>Now open your browser devtool, paste these into javascript console, hit them one by one.</p>
<pre><code>  document.querySelector('div[data-disabled] table td span[title] span[title="Inspect URL"]').click()

  document.querySelector('span[data-event-action=request-indexing] span[jsslot] div span span').click()

  document.querySelector('span[data-event-action=pivot-to-report-main-view-indexing-section] a').click()
</code></pre>
<p>Until you met with the daily quota. Rinse and try this shit everyday.</p>
<p>Fuck Google.</p></p>
            <div class="card-subtext muted-text">
              <p>Posted <time datetime="2021-10-21T14:53:25+08:00">2021-10-21</time></p>
<p>stdout</p>            </div>
          </article>
        </div>

    </main>
    <nav class="pagination-nav side-padding">
<a href="/category/stdout.02.html" class="pagination-older">Older Posts &gt;</a>    </nav>


  </body>
</html>