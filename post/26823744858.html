<!DOCTYPE html>
<html>
  <head>
    <title>DIY OAuth 2 libraryï¼šä»97KBåˆ°22è¡ŒPython - ğŸ‘â€ğŸ—¨ ğŸ’­ ğŸ’« ğŸ…±ã’</title>

    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link href="https://feeds.feedburner.com/initiative" type="application/rss+xml" rel="alternate" title="ğŸ‘â€ğŸ—¨ ğŸ’­ ğŸ’« ğŸ…±ã’ RSS Feed" />

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="DIY OAuth 2 libraryï¼šä»97KBåˆ°22è¡ŒPython" />

      <link rel="canonical" href="https://blog.est.im/post/26823744858" />

    <link rel="stylesheet" href="/theme/css/normalize.min.css" />
    <link rel="stylesheet" href="/theme/css/style.css" />


    <style>
      body {
        background: #ecedef url("/theme/img/ignasi_pattern_s.png") repeat;
      }
    </style>
  </head>
  <body class="single-body">
<nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="/" class="nav-text">
    ğŸ‘â€ğŸ—¨ ğŸ’­ ğŸ’« ğŸ…±ã’
  </a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://feeds.feedburner.com/initiative" class="hamburger-menu-overlay-link">RSS</a></li>
      <li><a href="/about" class="hamburger-menu-overlay-link">About</a></li>

      <li><a href="/category/archive" class="hamburger-menu-overlay-link active">archive</a></li>
      <li><a href="/category/stderr" class="hamburger-menu-overlay-link">stderr</a></li>
      <li><a href="/category/stdin" class="hamburger-menu-overlay-link">stdin</a></li>
      <li><a href="/category/stdout" class="hamburger-menu-overlay-link">stdout</a></li>

    </ul>
  </div>
</nav>    <main class="content side-text-padding">


<article class="post">
  <header class="post-header">
    <h2 class="post-title">DIY OAuth 2 libraryï¼šä»97KBåˆ°22è¡ŒPython</h2>
    <p class="post-date">Posted <time datetime="2012-07-09T05:23:00+08:00">2012-07-09</time> | <span>archive</span></p>
  </header>

  
  <p>æœ€è¿‘çš„é¡¹ç›®éœ€è¦ç”¨ä»£ç å»è¯»å–ä¸€äº›Google Spreadsheetçš„æ•°æ®ï¼Œçœ‹äº†ä¸‹Googleå®˜æ–¹çš„Spreadsheet APIï¼Œè¯»å–æ•°æ®è¿™äº›å¥½è¯´ï¼Œå°±æ˜¯xmlæ ¼å¼æˆ‘æ¯”è¾ƒè®¨åŒã€‚äºæ˜¯æƒ³ç”¨<code>alt=json</code>è¿™ä¸ª<a href="https://developers.google.com/gdata/docs/json">jsonè¾“å‡ºAPI</a>ï¼Œè¯•ç”¨å‘ç°ï¼Œå¯¹äºClientLoginï¼ˆæµè§ˆå™¨cookieï¼‰ç›´æ¥è°ƒç”¨Spreadsheet APIçš„Google Appsç”¨æˆ·è€Œè¨€ï¼Œè¿™ä¸ªjsonè¾“å‡ºæ˜¯400ä¸å¯ç”¨çš„ã€‚äºæ˜¯åªèƒ½æ’¸ä¸€ä¸ªOAuthè¯»å–æ•°æ®è¯•è¯•äº†ã€‚</p>
<p>çœ‹äº†ä¸‹å®˜æ–¹çš„<a href="http://code.google.com/p/gdata-python-client/">Google Data APIs Python Client Library</a>ï¼Œæˆ‘å‹’ä¸ªæ“¦å•Šï¼Œä¸€å¤§å¨åƒåœ¾ä¾èµ–ï¼Œæ¯”å¦‚<code>OpenSSL.crypto</code>ï¼Œ<a href="http://code.google.com/p/httplib2/source/browse/python2/httplib2/__init__.py">httplib2</a>ç­‰ã€‚</p>
<p>ä»”ç»†çœ‹äº†ä¸‹Google <a href="https://developers.google.com/accounts/docs/OAuth2ServiceAccount">OAuth 2.0</a>çš„æ–‡æ¡£ï¼Œä¼¼ä¹ä¹Ÿä¸å¤æ‚çš„æ ·å­ï¼Œè‡³å°‘æ¯”<a href="http://initiative.yo2.cn/archives/633801">OAuth 1.0 é‚£ç§3 legged login</a> ç®€å•å¤šäº†ã€‚äºæ˜¯å°±è‡ªå·±DIYäº†ä¸€ä¸ª</p>
<p>OAuth 2.0æŠŠæµç¨‹åˆ†ä¸ºäº†å‡ ä¸ªscenarioï¼Œæ¯”å¦‚ç”¨äºWebäº¤äº’ï¼Œå®¢æˆ·ç«¯appï¼Œè®¾å¤‡ï¼Œç­‰ç­‰ã€‚æˆ‘éœ€è¦çš„åªæ˜¯æœåŠ¡å™¨è¯»å–æŸä¸ªGoogle Spreadsheetçš„ä¸€äº›æ•°æ®ï¼Œæ— é¡»ç”¨æˆ·ç‚¹å‡»å‡ ä¸ªâ€œç¡®è®¤â€ï¼Œæ‰€ä»¥å±äºService Account</p>
<p>å½“ç„¶ï¼Œå®˜æ–¹<a href="https://developers.google.com/accounts/docs/OAuth2ServiceAccount#overview">å¼ºçƒˆä¸æ¨è</a>ä½ è‡ªå·±å»å®ç°OAuth 2.0è¿™ä¸€å¥—æµç¨‹</p>
<p>&gt; The rest of this article describes the specifics of creating a JWT, signing the JWT, forming the access token request, and handling the response. Libraries should abstract these specifics from your application. Again, developers are strongly encouraged to attempt to use an existing library <strong>rather than building your own</strong> support for server-to-server interactions.</p>
<p>æ‰€ä»¥æˆ‘å°±ç›´æ¥å»é€†å‘ä»–ä»¬çš„<a href="http://code.google.com/p/google-api-python-client/source/browse/samples/service_account/tasks.py">Tasks API with a Service account</a> sample</p>
<p>å®‰è£…äº†ä¸€å¤§ç¥¨ä¾èµ–ï¼Œç—›è‹¦ç¼–è¯‘å¥½pyopensslä¹‹åï¼Œç›´æ¥è¿è¡Œï¼Œå‡ºé”™ï¼š</p>
<pre><code>  oauth2client.client.AccessTokenRefreshError: invalid_grant
</code></pre>
<p>åŠ ä¸ªFiddlerä»£ç†è°ƒè¯•ï¼š</p>
<pre><code>  http = httplib2.Http(
    proxy_info=httplib2.ProxyInfo(
      httplib2.socks.PROXY_TYPE_HTTP, 
      proxy_host='10.0.18.2', 
      proxy_port=8888
  ), ca_certs='FiddlerRoot.cer')
</code></pre>
<p>å‘ç°httpsä¸æ”¯æŒã€‚äºæ˜¯</p>
<pre><code>  httplib2.debuglevel = 4
</code></pre>
<p>ç»ˆäºçœ‹åˆ°ä¸€å¨ä¸œè¥¿äº†ã€‚</p>
<p>å¯¹æ¯”ä¸Šé¢é‚£ä¸ª OAuth 2æ–‡æ¡£ï¼Œå¯ä»¥è½»æ¾å†™å‡ºOAuth 2.0è·å¾—access_tokençš„ä»£ç ï¼š</p>
<p>éœ€è¦ç”¨åˆ°APIç”¨æˆ·emailï¼Œp12å¯†é’¥ä¸¤ä¸ªä¸œè¥¿ï¼Œå¯ä»¥ä»Google API Consoleé‡Œè·å¾—ã€‚</p>
<pre><code>  import base64

  b64 = lambda x:base64.urlsafe_b64encode(x).rstrip('=')

  header = '{"alg":"RS256","typ":"JWT"}'
  ts_now = int(time.time())

  claim_set = {
      "iss": email,
      "scope": ' '.join(scope),
      "aud": "https://accounts.google.com/o/oauth2/token",
      "exp": ts_now+3600,
      "iat": ts_now,
  }

  jwt = '%s.%s' % (url_b64(header), url_b64(json.dumps(claim_set)))
  # convert pkcs12 to private key
  p = Popen('openssl pkcs12 -in key.p12 -nocerts -passin stdin -nodes -out key.pem', shell=True, stdin=PIPE, stdout=PIPE)
  p.stdin.write('notasecret') # Google's key default password
  p.stdin.close()
  p.wait()
  # RSA sign with sha256 using private key
  p = Popen('openssl dgst -sha256 -sign 'key.pem' -keyform PEM', shell=True, stdin=PIPE, stdout=PIPE)
  p.stdin.write(jwt)
  p.stdin.close()
  sig = p.stdout.read()
  p.wait()

  print '%s.%s' % (jwt, url_b64(sig))
</code></pre>
<p>æœ‰äº†access_tokenä¹‹åï¼Œè·å–spreadsheetæ•°æ®å°±å¾ˆç®€å•äº†ï¼Œæˆ‘ä¹Ÿæ‹¿<a href="https://developers.google.com/gdata/samples/spreadsheet_sample">sampleé‡Œ</a>çš„spreadsheetä½œä¸ºä¾‹å­ï¼š</p>
<p>https://spreadsheets.google.com/feeds/list/o13394135408524254648.240766968415752635/od6/public/values?alt=json&amp;access_token=1/XXXXX</p>
<p>å…¶ä¸­<code>1/XXXXX</code> å°±æ˜¯OAuth 2.0å¾—åˆ°çš„access_tokenã€‚</p>
<p>å¯¹æ¯”ä¸€ä¸‹ï¼Œä¸Šé¢æåˆ°çš„Googleå®˜æ–¹çš„OAuth 2 libraryæ˜¯97KBå¤§å°ï¼Œè‡ªå·±DIYçš„ç®—ä¸Šæ³¨é‡Šéƒ½æ‰åªæœ‰22è¡Œã€‚ã€‚ã€‚</p>
<p>Googleå®¢æˆ·ç«¯çš„ä»£ç æ˜¯ç”¨äº†<code>import OpenSSL</code>æ¥ç›´æ¥å®ç°RSA SHA256ç­¾åï¼Œæˆ‘ç›´æ¥å…ˆåå¯åŠ¨ä¸¤ä¸ªopensslå‘½ä»¤è¡Œå®ç°çš„ã€‚å¥½å¤„æ˜¯ä¸ç”¨éº»çƒ¦çš„ç¼–è¯‘pyopensslè¿™ä¸ªåº“ä¾èµ–äº†ã€‚æœåŠ¡å™¨éƒ¨ç½²æ–¹ä¾¿ã€‚</p>

</article>


<div class="comments">
  <h2>Comments</h2>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'estblog';
    var disqus_identifier = 'post/26823744858';
    var disqus_url = location.href;
    (function() {
    var dsq = document.createElement('script'); 

    dsq.type = 'text/javascript';
    dsq.defer = true;
    dsq.src = '//estblog.disqus.com/embed.js';
    (document.getElementsByTagName('body')[0] || document.getElementsByTagName('head')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the comments.</noscript>
</div>    </main>
<script src="/theme/js/core.js"></script>

  </body>

</html>