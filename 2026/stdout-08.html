<!DOCTYPE html>
<html>
  <head>
    <title>isomorphic-git 实现 sparse checkout &amp; commit – est の 输入 输出和出入</title>
<link rel="icon" href="https://est.im/favicon.svg">
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' https://disqus.com https://player.bilibili.com https://www.youtube.com;">
    <link href="https://feeds.feedburner.com/initiative" type="application/rss+xml" rel="alternate" title="est の 输入 输出和出入 RSS Feed" />

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="isomorphic-git 实现 sparse checkout &amp; commit" />

    <link rel="canonical" href="https://blog.est.im/2026/stdout-08" />
    <meta property="og:url" content="https://blog.est.im/2026/stdout-08">
    <meta property="og:type" content="article">
    <meta property="og:title" content="isomorphic-git 实现 sparse checkout &amp; commit">

    <link rel="stylesheet" href="/theme/css/normalize.min.css" />
    <link rel="stylesheet" href="/theme/css/style.css" />


    <style>
      body {
        background: #ecedef url("/theme/img/ignasi_pattern_s.png") repeat;
      }
    </style>
  </head>
  <body class="single-body">
<nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="/" class="nav-text">
    est の 输入 输出和出入
  </a></h1>
  <div class="hamburger-menu">
    <button>
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://feeds.feedburner.com/initiative" class="hamburger-menu-overlay-link">RSS</a></li>
      <li><a href="/about" class="hamburger-menu-overlay-link">About</a></li>
      <li><a href="/category" class="hamburger-menu-overlay-link">Category</a></li>

    </ul>
  </div>
</nav>    <main class="content side-text-padding">
<article class="post">
  <header class="post-header">
    <h2 class="post-title">isomorphic-git 实现 sparse checkout & commit</h2>
    <p class="post-date">Posted <time datetime="2026-02-14T01:08:00+08:00">2026-02-14</time> | <span>stdout</span></p>
  </header>

  
  <p>去年9月<a href="https://blog.est.im/2025/stdout-07">手搓了套blog评论系统 - req4cmt</a>，可能是全世界很少见通过 git repo 文件本身存储评论内容，而不是 github issue。</p>
<p>git repo 文件 append 内容涉及到一个性能问题：repo作为整体，也就是历史所有全体评论，被 fetch, commit , push 的成本太高。如果只能修改其中的一个文件就好了。这就是 sparse checkout。git底层早就支持了，git 命令在2020年之后2.25.0+支持，但是 Cloudflare Worker 没法执行命令，也没文件系统，于是召唤AI跟我一起折腾。</p>
<p>大概用的这个 prompt：</p>
<blockquote>
<ol>
<li>核心目的是避免 clone 整个repo！！</li>
<li>注意在 cloudflare worker 上跑。和nodejs有点差别。</li>
<li>git 命令在 cloudflare worker 是不能用的！所以引入了 isomorphic-git 这个库纯js实现git。不懂就去翻它的源码</li>
<li>在本地调试可以用 git 看看问题，但是实际操作肯定是要用  isomorphic-git 通过 http 进行的</li>
<li>注意 cloudflare worker 是没有文件系统的，所以引入 memfs </li>
</ol>
</blockquote>
<p>第一版 直接用 <code>await git.clone({fs, dir, url: GIT_URL, depth: 1, singleBranch: true});</code>， 改成 init + fetch。只拿tree和需要的blob</p>
<p>写完一跑，报错："git.hashObject is not a function"。AI一看扭头就去撸了个 SHA-1 准备造个git轮子。。。赶紧停下来调教，让它仔细读isomorphic-git源码，让用 <code>git.writeBlob</code>：</p>
<p>最折磨人的坑：文件覆盖问题。去年用 gemini-2.5，trae 搞不定，这次也是反复改了好几个方案才解决。现象是修改的那个文件提交，仓库里就只剩下修改的那一个文件，其他文件全没了。git.writeTree给我整不会了。这次让AI反复尝试了很多方案，最后有希望是先删除旧的，再添加新的</p>
<pre><code class="language-javascript">const oldTree = await git.readTree(...);
const filteredEntries = oldTree.tree.filter(e =&gt; e.path !== &quot;test.txt&quot;);
const newTreeSha = await git.writeTree(...);
</code></pre>
<p>这个方案对根目录文件有效，但子目录文件还是不行！因为 <code>git.readTree</code> 只能读根目录，<code>subdir/test.txt</code> 的 entry 在根目录的 tree 里是 <code>subdir</code> 这个 tree entry，不是文件本身。</p>
<p>没办法，搞了个巨蛋痛的10多行递归读取整个 tree，但是<code>git.writeTree</code> 不接受带斜杠的路径，报错："The filepath 'subdir/test.txt' contains unsafe character sequences"。</p>
<p>然后又得笨办法构建嵌套的 tree。这个方案终于成功了！但有个问题：每次都要递归读取整个 tree，然后重建整个 tree，效率太低了。特别是大仓库，会很慢。所以又不得不在解析path的时候只更新必要的部分</p>
<p>还尝试过一些其他方案：</p>
<ol>
<li>用 git.updateIndex：想通过 index 来管理文件，但 isomorphic-git 不支持 <code>git.readIndex</code>，也没法清空 index。</li>
<li>用 git.resetIndex：想重置 index，但这个函数需要 filepath 参数，没法清空整个 index。</li>
<li>手动管理 index 对象：想自己构建 index 对象传给 <code>git.writeTree</code>，但 <code>git.writeTree</code> 不接受 index 参数。</li>
<li>用 git.add：想用 <code>git.add</code> 来添加文件，但 <code>git.add</code> 需要文件系统里的文件，而 memfs 里没有这个文件。</li>
</ol>
<p>一整套下来感觉人都给整神了。。。</p>
</article>

<div class="comments">
  <h2>Comments</h2>
  <script type="text/javascript" defer src="https://c.est.im/req4cmt.js"></script>
</div>    </main>


  </body>

</html>